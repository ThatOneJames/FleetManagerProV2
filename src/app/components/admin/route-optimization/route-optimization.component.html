<div class="route-optimization-container">
    <div class="header">
        <h2>Route Management</h2>
        <button class="btn-primary" (click)="openCreateModal()">
            <i class="icon-plus"></i> Create Route
        </button>
    </div>

    <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
        <button (click)="errorMessage = ''" class="close-btn">×</button>
    </div>

    <div class="search-filter">
        <input [(ngModel)]="searchRoute"
               placeholder="Search by route name or vehicle..."
               class="search-input" />
        <select [(ngModel)]="filterStatus" class="filter-select">
            <option value="">All Statuses</option>
            <option value="planned">Planned</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
        </select>
    </div>

    <div *ngIf="loading" class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <div class="route-list" *ngIf="!loading">
        <div *ngFor="let route of filteredRoutes" class="route-card">
            <div class="route-header">
                <h3>{{ route.name }}</h3>
                <span class="status-badge" [ngClass]="getStatusClass(route.status!)">
                    {{ route.status }}
                </span>
            </div>

            <div class="route-info">
                <div class="info-row">
                    <span class="label">Vehicle:</span>
                    <span>{{ route.vehiclePlate }}</span>
                </div>
                <div class="info-row">
                    <span class="label">Driver:</span>
                    <span>{{ route.driverName }}</span>
                </div>
                <div class="info-row">
                    <span class="label">Estimated Distance:</span>
                    <span>{{ route.totalDistance }} km</span>
                </div>
                <div class="info-row">
                    <span class="label">Estimated Duration:</span>
                    <span>{{ route.estimatedDuration }} mins</span>
                </div>
                <div class="info-row">
                    <span class="label">Stops:</span>
                    <span>{{ route.stops.length }}</span>
                </div>
                <div class="info-row" *ngIf="route.description">
                    <span class="label">Description:</span>
                    <span>{{ route.description }}</span>
                </div>
            </div>

            <div class="route-actions">
                <button class="btn-maps"
                        (click)="openGoogleMaps(route)"
                        *ngIf="route.stops && route.stops.length > 0">
                    <i class="icon-map"></i> Open in Maps
                </button>
                <button class="btn-copy"
                        (click)="copyGoogleMapsUrl(route)"
                        *ngIf="route.stops && route.stops.length > 0">
                    <i class="icon-copy"></i> Copy Map Link
                </button>

                <button class="btn-view" (click)="viewRouteStops(route)">
                    <i class="icon-list"></i> View Stops
                </button>

                <button class="btn-start"
                        (click)="startRoute(route.id!)"
                        *ngIf="route.status === 'planned'">
                    <i class="icon-play"></i> Start Route
                </button>

                <button class="btn-complete"
                        (click)="completeRoute(route.id!)"
                        *ngIf="route.status === 'in_progress'">
                    <i class="icon-check"></i> Complete
                </button>

                <button class="btn-pending"
                        (click)="setPendingRoute(route.id!)"
                        *ngIf="route.status === 'completed' || route.status === 'cancelled'">
                    <i class="icon-reset"></i> Set to Pending
                </button>

                <button class="btn-cancel"
                        (click)="cancelRoute(route.id!)"
                        *ngIf="route.status === 'planned' || route.status === 'in_progress'">
                    <i class="icon-cancel"></i> Cancel Route
                </button>

                <button class="btn-optimize"
                        (click)="openEditModal(route)"
                        *ngIf="route.status === 'planned'">
                    <i class="icon-edit"></i> Edit Route
                </button>

                <button class="btn-delete"
                        (click)="deleteRoute(route.id!)"
                        *ngIf="route.status !== 'in_progress'">
                    <i class="icon-trash"></i> Delete
                </button>
            </div>
        </div>

        <div *ngIf="filteredRoutes.length === 0" class="no-routes">
            <div class="no-routes-icon">🗺️</div>
            <h3>No Routes Found</h3>
            <p>No routes match your search criteria. Try adjusting your filters or create a new route!</p>
        </div>
    </div>

    <div class="modal" *ngIf="showCreateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Route</h3>
                <button class="close-btn" (click)="closeCreateModal()">×</button>
            </div>

            <form class="route-form">
                <div class="form-group">
                    <label>Route Name *</label>
                    <input type="text"
                           [(ngModel)]="newRoute.name"
                           name="routeName"
                           placeholder="Enter route name"
                           required />
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea [(ngModel)]="newRoute.description"
                              name="description"
                              placeholder="Enter route description"
                              rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Vehicle *</label>
                        <select [(ngModel)]="newRoute.vehicleId" name="vehicle" required>
                            <option value="">Select Vehicle</option>
                            <option *ngFor="let vehicle of vehicles" [value]="vehicle.id">
                                {{ vehicle.licensePlate }} - {{ vehicle.make }} {{ vehicle.model }}
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Driver *</label>
                        <select [(ngModel)]="newRoute.driverId" name="driver" required>
                            <option value="">Select Driver</option>
                            <option *ngFor="let driver of drivers" [value]="driver.id">
                                {{ driver.name }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Start Address</label>
                        <input type="text"
                               [(ngModel)]="newRoute.startAddress"
                               name="startAddress"
                               placeholder="Starting location (optional)" />
                    </div>
                    <div class="form-group">
                        <label>Destination Address</label>
                        <input type="text"
                               [(ngModel)]="newRoute.destinationAddress"
                               name="destinationAddress"
                               placeholder="Final destination (optional)" />
                    </div>
                </div>

                <div class="stops-section">
                    <div class="stops-header">
                        <h4>Route Stops *</h4>
                        <button type="button"
                                class="btn-preview"
                                (click)="previewGoogleMaps()"
                                [disabled]="newRoute.stops.length === 0">
                            <i class="icon-preview"></i> Preview Route in Maps
                        </button>
                    </div>

                    <div class="stop-form">
                        <div class="form-group">
                            <input type="text"
                                   [(ngModel)]="newStop.address"
                                   name="stopAddress"
                                   placeholder="Stop address" />
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <select [(ngModel)]="newStop.priority" name="priority">
                                    <option value="low">Low Priority</option>
                                    <option value="normal">Normal Priority</option>
                                    <option value="high">High Priority</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="text"
                                       [(ngModel)]="newStop.contactName"
                                       name="contactName"
                                       placeholder="Contact name (optional)" />
                            </div>
                            <div class="form-group">
                                <input type="tel"
                                       [(ngModel)]="newStop.contactPhone"
                                       name="contactPhone"
                                       placeholder="Contact phone (optional)" />
                            </div>
                        </div>

                        <div class="form-group">
                            <textarea [(ngModel)]="newStop.notes"
                                      name="stopNotes"
                                      placeholder="Stop notes (optional)"
                                      rows="2"></textarea>
                        </div>

                        <button type="button" class="btn-add-stop" (click)="addStopToNewRoute()">
                            <i class="icon-plus"></i> Add Stop
                        </button>
                    </div>

                    <div class="google-maps-url" *ngIf="newRoute.googleMapsUrl">
                        <label>Generated Google Maps URL:</label>
                        <div class="url-display">
                            <input type="text" [value]="newRoute.googleMapsUrl" readonly />
                            <button type="button"
                                    class="btn-url-action"
                                    (click)="previewGoogleMaps()"
                                    title="Open in new tab">
                                <i class="icon-external"></i>
                            </button>
                        </div>
                    </div>

                    <div class="stops-list" *ngIf="newRoute.stops.length > 0">
                        <div *ngFor="let stop of newRoute.stops; let i = index" class="stop-item">
                            <div class="stop-order">{{ stop.stopOrder }}</div>
                            <div class="stop-details">
                                <div class="stop-address">{{ stop.address }}</div>
                                <div class="stop-meta">
                                    <span class="priority-badge" [ngClass]="getPriorityClass(stop.priority)">
                                        {{ stop.priority }}
                                    </span>
                                    <span *ngIf="stop.contactName" class="contact-info">
                                        <i class="icon-person"></i> {{ stop.contactName }}
                                    </span>
                                    <span *ngIf="stop.contactPhone" class="contact-info">
                                        <i class="icon-phone"></i> {{ stop.contactPhone }}
                                    </span>
                                </div>
                                <div class="stop-notes" *ngIf="stop.notes">
                                    <i class="icon-note"></i> {{ stop.notes }}
                                </div>
                            </div>
                            <button type="button" class="btn-remove" (click)="removeStopFromNewRoute(i)">
                                ×
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="closeCreateModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn-primary" (click)="createRoute()">
                        <i class="icon-save"></i> Create Route
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" *ngIf="showEditModal && editingRoute">
        <div class="modal-content edit-modal">
            <div class="modal-header">
                <h3>Edit Route: {{ editingRoute.name }}</h3>
                <button class="close-btn" (click)="closeEditModal()">×</button>
            </div>

            <form class="route-form">
                <div class="form-group">
                    <label>Route Name *</label>
                    <input type="text"
                           [(ngModel)]="editRoute.name"
                           name="editRouteName"
                           placeholder="Enter route name"
                           required />
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea [(ngModel)]="editRoute.description"
                              name="editDescription"
                              placeholder="Enter route description"
                              rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Vehicle *</label>
                        <select [(ngModel)]="editRoute.vehicleId" name="editVehicle" required>
                            <option value="">Select Vehicle</option>
                            <option *ngFor="let vehicle of vehicles" [value]="vehicle.id">
                                {{ vehicle.licensePlate }} - {{ vehicle.make }} {{ vehicle.model }}
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Driver *</label>
                        <select [(ngModel)]="editRoute.driverId" name="editDriver" required>
                            <option value="">Select Driver</option>
                            <option *ngFor="let driver of drivers" [value]="driver.id">
                                {{ driver.name }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="stops-section">
                    <div class="stops-header">
                        <h4>Route Stops</h4>
                        <button type="button"
                                class="btn-preview"
                                (click)="previewEditGoogleMaps()"
                                [disabled]="editRoute.stops.length === 0">
                            <i class="icon-preview"></i> Preview
                        </button>
                    </div>

                    <div class="stops-list-editable" *ngIf="editRoute.stops.length > 0">
                        <div *ngFor="let stop of editRoute.stops; let i = index" class="stop-item-editable">
                            <div class="stop-order">{{ stop.stopOrder }}</div>

                            <div class="stop-details-editable">
                                <input type="text"
                                       [(ngModel)]="stop.address"
                                       name="editStopAddress{{i}}"
                                       placeholder="Stop address"
                                       class="stop-address-input" />

                                <div class="stop-meta-inputs">
                                    <select [(ngModel)]="stop.priority" name="editPriority{{i}}" class="priority-select">
                                        <option value="low">Low Priority</option>
                                        <option value="normal">Normal Priority</option>
                                        <option value="high">High Priority</option>
                                    </select>

                                    <input type="text"
                                           [(ngModel)]="stop.contactName"
                                           name="editContactName{{i}}"
                                           placeholder="Contact name"
                                           class="contact-input" />

                                    <input type="tel"
                                           [(ngModel)]="stop.contactPhone"
                                           name="editContactPhone{{i}}"
                                           placeholder="Contact phone"
                                           class="contact-input" />
                                </div>

                                <textarea [(ngModel)]="stop.notes"
                                          name="editNotes{{i}}"
                                          placeholder="Stop notes"
                                          rows="2"
                                          class="stop-notes-input"></textarea>
                            </div>

                            <button type="button" class="btn-remove" (click)="removeStopFromEdit(i)">
                                ×
                            </button>
                        </div>
                    </div>

                    <div class="stop-form">
                        <h5>Add New Stop</h5>
                        <div class="form-group">
                            <input type="text"
                                   [(ngModel)]="editStop.address"
                                   name="newEditStopAddress"
                                   placeholder="Stop address" />
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <select [(ngModel)]="editStop.priority" name="newEditPriority">
                                    <option value="low">Low Priority</option>
                                    <option value="normal">Normal Priority</option>
                                    <option value="high">High Priority</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="text"
                                       [(ngModel)]="editStop.contactName"
                                       name="newEditContactName"
                                       placeholder="Contact name (optional)" />
                            </div>
                            <div class="form-group">
                                <input type="tel"
                                       [(ngModel)]="editStop.contactPhone"
                                       name="newEditContactPhone"
                                       placeholder="Contact phone (optional)" />
                            </div>
                        </div>

                        <div class="form-group">
                            <textarea [(ngModel)]="editStop.notes"
                                      name="newEditStopNotes"
                                      placeholder="Stop notes (optional)"
                                      rows="2"></textarea>
                        </div>

                        <button type="button" class="btn-add-stop" (click)="addStopToEdit()">
                            <i class="icon-plus"></i> Add Stop
                        </button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" (click)="closeEditModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn-primary" (click)="saveEditedRoute()">
                        <i class="icon-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" *ngIf="showStopsModal && selectedRoute">
        <div class="modal-content stops-modal">
            <div class="modal-header">
                <h3>{{ selectedRoute.name }} - Route Details</h3>
                <button class="close-btn" (click)="closeStopsModal()">×</button>
            </div>

            <div class="route-actions-bar">
                <button class="btn-maps-large" (click)="openGoogleMaps(selectedRoute)">
                    <i class="icon-map"></i> Navigate with Google Maps
                </button>
                <button class="btn-copy-large" (click)="copyGoogleMapsUrl(selectedRoute)">
                    <i class="icon-copy"></i> Copy Map Link
                </button>
            </div>

            <div class="route-overview">
                <div class="overview-grid">
                    <div class="overview-item">
                        <span class="label">Vehicle:</span>
                        <span>{{ selectedRoute.vehiclePlate }}</span>
                    </div>
                    <div class="overview-item">
                        <span class="label">Driver:</span>
                        <span>{{ selectedRoute.driverName }}</span>
                    </div>
                    <div class="overview-item">
                        <span class="label">Status:</span>
                        <span class="status-badge" [ngClass]="getStatusClass(selectedRoute.status!)">
                            {{ selectedRoute.status }}
                        </span>
                    </div>
                    <div class="overview-item">
                        <span class="label">Total Distance:</span>
                        <span>{{ selectedRoute.totalDistance }} km</span>
                    </div>
                    <div class="overview-item">
                        <span class="label">Estimated Duration:</span>
                        <span>{{ selectedRoute.estimatedDuration }} minutes</span>
                    </div>
                    <div class="overview-item">
                        <span class="label">Total Stops:</span>
                        <span>{{ selectedRoute.stops.length }}</span>
                    </div>
                </div>
            </div>

            <div class="stops-timeline">
                <h4>Route Stops</h4>
                <div *ngFor="let stop of selectedRoute.stops" class="timeline-item">
                    <div class="timeline-marker" [ngClass]="getStatusClass(stop.status!)"></div>
                    <div class="timeline-content">
                        <div class="stop-header">
                            <span class="stop-number">Stop {{ stop.stopOrder }}</span>
                            <span class="status-badge" [ngClass]="getStatusClass(stop.status!)">
                                {{ stop.status || 'pending' }}
                            </span>
                            <span class="priority-badge" [ngClass]="getPriorityClass(stop.priority)">
                                {{ stop.priority }}
                            </span>
                        </div>

                        <div class="stop-address">
                            <i class="icon-location"></i> {{ stop.address }}
                        </div>

                        <div class="stop-info" *ngIf="stop.contactName || stop.contactPhone">
                            <div *ngIf="stop.contactName" class="contact-item">
                                <i class="icon-person"></i>
                                <strong>Contact:</strong> {{ stop.contactName }}
                            </div>
                            <div *ngIf="stop.contactPhone" class="contact-item">
                                <i class="icon-phone"></i>
                                <strong>Phone:</strong> {{ stop.contactPhone }}
                            </div>
                        </div>

                        <div class="stop-times">
                            <div *ngIf="stop.estimatedArrival" class="time-item">
                                <strong>Est. Arrival:</strong> {{ stop.estimatedArrival | date:'short' }}
                            </div>
                            <div *ngIf="stop.actualArrival" class="time-item">
                                <strong>Actual Arrival:</strong> {{ stop.actualArrival | date:'short' }}
                            </div>
                            <div *ngIf="stop.estimatedDeparture" class="time-item">
                                <strong>Est. Departure:</strong> {{ stop.estimatedDeparture | date:'short' }}
                            </div>
                            <div *ngIf="stop.actualDeparture" class="time-item">
                                <strong>Actual Departure:</strong> {{ stop.actualDeparture | date:'short' }}
                            </div>
                        </div>

                        <div class="stop-notes" *ngIf="stop.notes">
                            <i class="icon-note"></i>
                            <strong>Notes:</strong> {{ stop.notes }}
                        </div>

                        <div class="stop-actions" *ngIf="selectedRoute.status === 'in_progress'">
                            <button class="btn-sm btn-success"
                                    (click)="updateStopStatus(stop.id!, 'arrived')"
                                    *ngIf="!stop.status || stop.status === 'pending'">
                                <i class="icon-check"></i> Mark Arrived
                            </button>
                            <button class="btn-sm btn-primary"
                                    (click)="updateStopStatus(stop.id!, 'completed')"
                                    *ngIf="stop.status === 'arrived'">
                                <i class="icon-complete"></i> Mark Completed
                            </button>
                            <button class="btn-sm btn-warning"
                                    (click)="updateStopStatus(stop.id!, 'skipped')"
                                    *ngIf="!stop.status || stop.status === 'pending' || stop.status === 'arrived'">
                                <i class="icon-skip"></i> Skip Stop
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>