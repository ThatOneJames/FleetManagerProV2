<div class="driver-management">
    <h2>Driver Management</h2>

    <!-- Controls -->
    <div class="controls">
        <input [(ngModel)]="searchText" placeholder="Search driver..." />
        <select [(ngModel)]="filterStatus">
            <option>All</option>
            <option>Active</option>
            <option>Inactive</option>
            <option>Suspended</option>
        </select>
        <button (click)="toggleAddDriverForm()" class="btn-primary">+ Add Driver</button>
        <button (click)="refreshAttendance()" class="btn-secondary" title="Refresh attendance status">
            🔄 Refresh Status
        </button>
        <button (click)="downloadAttendanceCSV()" class="btn-success" title="Download attendance report">
            📊 Download Attendance CSV
        </button>
    </div>

    <!-- Success/Error Messages -->
    <div *ngIf="successMessage" class="message success">{{ successMessage }}</div>
    <div *ngIf="errorMessage" class="message error">{{ errorMessage }}</div>

    <!-- Add Driver Form -->
    <div class="form-container" *ngIf="showAddDriverForm">
        <div class="form-header">
            <h3>Add New Driver</h3>
            <button type="button" class="close-btn" (click)="cancelForm()">&times;</button>
        </div>
        <form [formGroup]="registrationForm" (ngSubmit)="addDriver()">
            <div class="form-grid">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input formControlName="name" placeholder="Enter full name" required />
                    <div *ngIf="registrationForm.get('name')?.invalid && registrationForm.get('name')?.touched" class="error-text">
                        Name is required
                    </div>
                </div>

                <div class="form-group">
                    <label>Email *</label>
                    <input formControlName="email" type="email" placeholder="Enter email address" required />
                    <div *ngIf="registrationForm.get('email')?.invalid && registrationForm.get('email')?.touched" class="error-text">
                        Valid email is required
                    </div>
                </div>

                <div class="form-group">
                    <label>Password *</label>
                    <input formControlName="password" type="password" placeholder="Enter password" required />
                    <div *ngIf="registrationForm.get('password')?.invalid && registrationForm.get('password')?.touched" class="error-text">
                        Password must be at least 6 characters
                    </div>
                </div>

                <div class="form-group">
                    <label>Phone</label>
                    <input formControlName="phone" placeholder="Enter phone number" />
                </div>

                <div class="form-group">
                    <label>License Number</label>
                    <input formControlName="licenseNumber" placeholder="Enter license number" />
                </div>

                <div class="form-group full-width">
                    <label>License Classes * (Select at least one)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" *ngFor="let licenseClass of availableLicenseClasses">
                            <input type="checkbox"
                                   [id]="'reg-' + licenseClass.code"
                                   [checked]="isRegistrationLicenseSelected(licenseClass.code)"
                                   (change)="onRegistrationLicenseChange(licenseClass.code, $event)" />
                            <label [for]="'reg-' + licenseClass.code">
                                <strong>{{ licenseClass.code }}</strong> - {{ licenseClass.name }}
                            </label>
                        </div>
                    </div>
                    <div *ngIf="registrationForm.get('licenseClasses')?.invalid && registrationForm.get('licenseClasses')?.touched" class="error-text">
                        Please select at least one license class
                    </div>
                </div>

                <div class="form-group">
                    <label>License Expiry</label>
                    <input formControlName="licenseExpiry" type="date" />
                </div>

                <div class="form-group">
                    <label>Experience Years</label>
                    <input formControlName="experienceYears" type="number" min="0" placeholder="Years of experience" />
                </div>

                <div class="form-group">
                    <label>Address</label>
                    <textarea formControlName="address" placeholder="Enter address" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Date of Birth</label>
                    <input formControlName="dateOfBirth" type="date" />
                </div>

                <div class="form-group">
                    <label>Emergency Contact</label>
                    <input formControlName="emergencyContact" placeholder="Emergency contact info" />
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <select formControlName="status" class="form-control">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Suspended">Suspended</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Safety Rating</label>
                    <input formControlName="safetyRating" type="number" min="0" max="5" step="0.1" placeholder="0.0 - 5.0" />
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" [disabled]="registrationForm.invalid" class="btn-primary">Save Driver</button>
                <button type="button" (click)="cancelForm()" class="btn-secondary">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Edit Driver Form -->
    <div class="form-container" *ngIf="showEditDriverForm && editingDriver">
        <div class="form-header">
            <h3>Edit Driver: {{ editingDriver.name }}</h3>
            <button type="button" class="close-btn" (click)="cancelEdit()">&times;</button>
        </div>
        <form [formGroup]="editForm" (ngSubmit)="updateDriver()">
            <div class="form-grid">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input formControlName="name" placeholder="Enter full name" required />
                    <div *ngIf="editForm.get('name')?.invalid && editForm.get('name')?.touched" class="error-text">
                        Name is required
                    </div>
                </div>

                <div class="form-group">
                    <label>Email *</label>
                    <input formControlName="email" type="email" placeholder="Enter email address" required />
                    <div *ngIf="editForm.get('email')?.invalid && editForm.get('email')?.touched" class="error-text">
                        Valid email is required
                    </div>
                </div>

                <div class="form-group">
                    <label>Phone</label>
                    <input formControlName="phone" placeholder="Enter phone number" />
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <select formControlName="status">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Suspended">Suspended</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>License Number</label>
                    <input formControlName="licenseNumber" placeholder="Enter license number" />
                </div>

                <div class="form-group full-width">
                    <label>License Classes * (Select at least one)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item" *ngFor="let licenseClass of availableLicenseClasses">
                            <input type="checkbox"
                                   [id]="'edit-' + licenseClass.code"
                                   [checked]="isEditLicenseSelected(licenseClass.code)"
                                   (change)="onEditLicenseChange(licenseClass.code, $event)" />
                            <label [for]="'edit-' + licenseClass.code">
                                <strong>{{ licenseClass.code }}</strong> - {{ licenseClass.name }}
                            </label>
                        </div>
                    </div>
                    <div *ngIf="editForm.get('licenseClasses')?.invalid && editForm.get('licenseClasses')?.touched" class="error-text">
                        Please select at least one license class
                    </div>
                </div>

                <div class="form-group">
                    <label>License Expiry</label>
                    <input formControlName="licenseExpiry" type="date" />
                </div>

                <div class="form-group">
                    <label>Experience Years</label>
                    <input formControlName="experienceYears" type="number" min="0" placeholder="Years of experience" />
                </div>

                <div class="form-group">
                    <label>Address</label>
                    <textarea formControlName="address" placeholder="Enter address" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Date of Birth</label>
                    <input formControlName="dateOfBirth" type="date" />
                </div>

                <div class="form-group">
                    <label>Emergency Contact</label>
                    <input formControlName="emergencyContact" placeholder="Emergency contact info" />
                </div>

                <div class="form-group">
                    <label>Safety Rating</label>
                    <input formControlName="safetyRating" type="number" min="0" max="5" step="0.1" placeholder="0.0 - 5.0" />
                </div>

                <div class="form-group">
                    <label>Total Miles Driven</label>
                    <input formControlName="totalMilesDriven" type="number" min="0" placeholder="Total miles" />
                </div>

                <div class="form-group">
                    <label>Available</label>
                    <select formControlName="isAvailable">
                        <option [value]="true">Yes</option>
                        <option [value]="false">No</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Has Helper</label>
                    <select formControlName="hasHelper">
                        <option [value]="true">Yes</option>
                        <option [value]="false">No</option>
                    </select>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" [disabled]="editForm.invalid" class="btn-primary">Update Driver</button>
                <button type="button" (click)="cancelEdit()" class="btn-secondary">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Driver List Table -->
    <div class="driver-list">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>License</th>
                        <th>Experience</th>
                        <th>Status</th>
                        <th>Clock-In Status</th>
                        <th>Safety Rating</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let driver of filteredDrivers">
                        <td>
                            <div class="driver-name-cell">
                                <span class="driver-name">{{ driver.name }}</span>
                                <span class="license-warning" *ngIf="isLicenseExpiringSoon(driver)" title="License expiring soon">
                                    ⚠️
                                </span>
                                <span class="license-expired" *ngIf="isLicenseExpired(driver)" title="License expired">
                                    ❌
                                </span>
                            </div>
                        </td>
                        <td>{{ driver.email }}</td>
                        <td>{{ driver.phone || 'N/A' }}</td>
                        <td>
                            <div class="license-info">
                                <div>{{ driver.licenseNumber || 'N/A' }}</div>
                                <div class="license-classes">{{ driver.licenseClass || 'N/A' }}</div>
                            </div>
                        </td>
                        <td>{{ driver.experienceYears || 0 }} years</td>
                        <td>
                            <span class="status-badge" [class]="getStringStatus(driver.status).toLowerCase()">
                                {{ getStringStatus(driver.status) }}
                            </span>
                        </td>
                        <!-- ✅ FIXED: Use getAvailabilityClass instead of hasDriverClockedInToday -->
                        <td>
                            <div *ngIf="!isLoadingAttendance" class="clock-in-status">
                                <span class="availability-badge"
                                      [ngClass]="getAvailabilityClass(driver.id!)">
                                    {{ getAvailabilityText(driver.id!) }}
                                </span>
                                <div class="availability-subtitle">
                                    {{ getAvailabilitySubtitle(driver.id!) }}
                                </div>
                            </div>
                            <div *ngIf="isLoadingAttendance" class="loading-indicator">
                                <span class="spinner-small"></span>
                            </div>
                        </td>
                        <td>
                            <span class="safety-rating">
                                {{ driver.safetyRating || 'N/A' }}/5.0
                                <span class="rating-stars" *ngIf="driver.safetyRating">
                                    {{ getRatingStars(driver.safetyRating) }}
                                </span>
                            </span>
                        </td>
                        <td class="actions">
                            <button (click)="editDriver(driver)" class="btn-edit" title="Edit">
                                <i class="icon-edit">✏️</i>
                            </button>
                            <button (click)="confirmDelete(driver)" class="btn-delete" title="Delete">
                                <i class="icon-delete">🗑️</i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div *ngIf="filteredDrivers.length === 0" class="no-data">
            <p>No drivers found matching your criteria.</p>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" *ngIf="showDeleteConfirm">
        <div class="modal">
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete driver <strong>{{ driverToDelete?.name }}</strong>?</p>
            <p class="warning-text">This action cannot be undone.</p>
            <div class="modal-actions">
                <button (click)="deleteDriver()" class="btn-danger">Delete</button>
                <button (click)="cancelDelete()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>
