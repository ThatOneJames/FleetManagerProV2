<!-- Fleet Management Component -->
<div class="fleet-management-container">
    <!-- Header Section -->
    <div class="header-section">
        <h2 class="page-title">Fleet Management</h2>
        <p class="page-subtitle">Manage your fleet vehicles, assignments, and maintenance schedules</p>
    </div>

    <!-- Success/Error Messages -->
    <div *ngIf="successMessage" class="alert success-alert">
        <span class="alert-icon">✓</span>
        {{ successMessage }}
    </div>

    <div *ngIf="errorMessage" class="alert error-alert">
        <span class="alert-icon">⚠</span>
        {{ errorMessage }}
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
        <!-- Search and Filters -->
        <div class="search-filter-row">
            <div class="search-container">
                <input type="text"
                       placeholder="Search vehicles by make, model, license plate, or driver..."
                       [(ngModel)]="searchText"
                       (input)="onSearchChange()"
                       class="search-input">
            </div>

            <div class="filter-container">
                <select [(ngModel)]="statusFilter" (change)="onStatusFilterChange()" class="filter-select">
                    <option value="">All Status</option>
                    <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
                </select>

                <select [(ngModel)]="categoryFilter" (change)="onCategoryFilterChange()" class="filter-select">
                    <option value="">All Categories</option>
                    <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
                </select>

                <select [(ngModel)]="fuelTypeFilter" (change)="onFuelTypeFilterChange()" class="filter-select">
                    <option value="">All Fuel Types</option>
                    <option *ngFor="let fuelType of fuelTypeOptions" [value]="fuelType">{{ fuelType }}</option>
                </select>

                <button class="clear-filters-btn" (click)="clearFilters()">Clear Filters</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="add-vehicle-btn" (click)="showAddVehicleForm()">
                + Add Vehicle
            </button>
            <button class="export-btn" (click)="exportToCSV()">
                Export CSV
            </button>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading vehicles...</p>
    </div>

    <!-- Add Vehicle Form -->
    <div *ngIf="showAddForm" class="modal-overlay" (click)="hideAddVehicleForm()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Add New Vehicle</h3>
                <button class="modal-close" (click)="hideAddVehicleForm()">&times;</button>
            </div>

            <form [formGroup]="vehicleForm" (ngSubmit)="onSubmitAdd()" class="vehicle-form">
                <div class="form-grid">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h4>Basic Information</h4>

                        <div class="form-group">
                            <label for="category">Category *</label>
                            <select formControlName="categoryId" id="category" class="form-control"
                                    [class.error]="isFieldInvalid(vehicleForm, 'categoryId')">
                                <option value="">Select Category</option>
                                <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
                            </select>
                            <div *ngIf="isFieldInvalid(vehicleForm, 'categoryId')" class="error-message">
                                {{ getFieldError(vehicleForm, 'categoryId') }}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="make">Make *</label>
                                <input type="text" formControlName="make" id="make" class="form-control"
                                       [class.error]="isFieldInvalid(vehicleForm, 'make')" placeholder="Toyota">
                                <div *ngIf="isFieldInvalid(vehicleForm, 'make')" class="error-message">
                                    {{ getFieldError(vehicleForm, 'make') }}
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="model">Model *</label>
                                <input type="text" formControlName="model" id="model" class="form-control"
                                       [class.error]="isFieldInvalid(vehicleForm, 'model')" placeholder="Camry">
                                <div *ngIf="isFieldInvalid(vehicleForm, 'model')" class="error-message">
                                    {{ getFieldError(vehicleForm, 'model') }}
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="year">Year *</label>
                                <input type="number" formControlName="year" id="year" class="form-control"
                                       [class.error]="isFieldInvalid(vehicleForm, 'year')" placeholder="2024">
                                <div *ngIf="isFieldInvalid(vehicleForm, 'year')" class="error-message">
                                    {{ getFieldError(vehicleForm, 'year') }}
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="licensePlate">License Plate *</label>
                                <input type="text" formControlName="licensePlate" id="licensePlate" class="form-control"
                                       [class.error]="isFieldInvalid(vehicleForm, 'licensePlate')" placeholder="ABC-123">
                                <div *ngIf="isFieldInvalid(vehicleForm, 'licensePlate')" class="error-message">
                                    {{ getFieldError(vehicleForm, 'licensePlate') }}
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="color">Color</label>
                                <input type="text" formControlName="color" id="color" class="form-control" placeholder="White">
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Specifications -->
                    <div class="form-section">
                        <h4>Vehicle Specifications</h4>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fuelType">Fuel Type *</label>
                                <select formControlName="fuelType" id="fuelType" class="form-control">
                                    <option *ngFor="let fuel of fuelTypeOptions" [value]="fuel">{{ fuel }}</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="fuelCapacity">Fuel Capacity (L)</label>
                                <input type="number" formControlName="fuelCapacity" id="fuelCapacity" class="form-control"
                                       placeholder="50" step="0.01">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="currentMileage">Current Mileage *</label>
                                <input type="number" formControlName="currentMileage" id="currentMileage" class="form-control"
                                       [class.error]="isFieldInvalid(vehicleForm, 'currentMileage')" placeholder="0" step="0.01">
                                <div *ngIf="isFieldInvalid(vehicleForm, 'currentMileage')" class="error-message">
                                    {{ getFieldError(vehicleForm, 'currentMileage') }}
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="fuelLevel">Fuel Level (%) *</label>
                                <input type="number" formControlName="fuelLevel" id="fuelLevel" class="form-control"
                                       [class.error]="isFieldInvalid(vehicleForm, 'fuelLevel')" placeholder="100" min="0" max="100">
                                <div *ngIf="isFieldInvalid(vehicleForm, 'fuelLevel')" class="error-message">
                                    {{ getFieldError(vehicleForm, 'fuelLevel') }}
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="status">Status *</label>
                            <select formControlName="status" id="status" class="form-control">
                                <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Documentation -->
                    <div class="form-section">
                        <h4>Documentation</h4>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="registrationExpiry">Registration Expiry *</label>
                                <input type="date" formControlName="registrationExpiry" id="registrationExpiry" class="form-control"
                                       [class.error]="isFieldInvalid(vehicleForm, 'registrationExpiry')">
                                <div *ngIf="isFieldInvalid(vehicleForm, 'registrationExpiry')" class="error-message">
                                    {{ getFieldError(vehicleForm, 'registrationExpiry') }}
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="insuranceExpiry">Insurance Expiry *</label>
                                <input type="date" formControlName="insuranceExpiry" id="insuranceExpiry" class="form-control"
                                       [class.error]="isFieldInvalid(vehicleForm, 'insuranceExpiry')">
                                <div *ngIf="isFieldInvalid(vehicleForm, 'insuranceExpiry')" class="error-message">
                                    {{ getFieldError(vehicleForm, 'insuranceExpiry') }}
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="insurancePolicy">Insurance Policy Number</label>
                            <input type="text" formControlName="insurancePolicy" id="insurancePolicy" class="form-control"
                                   placeholder="Policy number">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="purchaseDate">Purchase Date</label>
                                <input type="date" formControlName="purchaseDate" id="purchaseDate" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="purchasePrice">Purchase Price</label>
                                <input type="number" formControlName="purchasePrice" id="purchasePrice" class="form-control"
                                       placeholder="25000" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="cancel-btn" (click)="hideAddVehicleForm()">Cancel</button>
                    <button type="submit" class="submit-btn" [disabled]="vehicleForm.invalid || isLoading">
                        {{ isLoading ? 'Adding...' : 'Add Vehicle' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Vehicle Form -->
    <div *ngIf="showEditForm" class="modal-overlay" (click)="hideEditForm()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Edit Vehicle</h3>
                <button class="modal-close" (click)="hideEditForm()">&times;</button>
            </div>

            <form [formGroup]="editForm" (ngSubmit)="onSubmitEdit()" class="vehicle-form">
                <div class="form-grid">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h4>Basic Information</h4>

                        <div class="form-group">
                            <label for="editCategory">Category *</label>
                            <select formControlName="categoryId" id="editCategory" class="form-control">
                                <option value="">Select Category</option>
                                <option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editMake">Make *</label>
                                <input type="text" formControlName="make" id="editMake" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="editModel">Model *</label>
                                <input type="text" formControlName="model" id="editModel" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="editYear">Year *</label>
                                <input type="number" formControlName="year" id="editYear" class="form-control">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editLicensePlate">License Plate *</label>
                                <input type="text" formControlName="licensePlate" id="editLicensePlate" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="editColor">Color</label>
                                <input type="text" formControlName="color" id="editColor" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- Assignment -->
                    <div class="form-section">
                        <h4>Assignment</h4>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editStatus">Status *</label>
                                <select formControlName="status" id="editStatus" class="form-control">
                                    <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="editDriver">Assigned Driver</label>
                                <select formControlName="currentDriverId" id="editDriver" class="form-control">
                                    <option value="">Unassigned</option>
                                    <option *ngFor="let driver of availableDrivers" [value]="driver.id">{{ driver.name }}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Specifications -->
                    <div class="form-section">
                        <h4>Vehicle Specifications</h4>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editFuelType">Fuel Type *</label>
                                <select formControlName="fuelType" id="editFuelType" class="form-control">
                                    <option *ngFor="let fuel of fuelTypeOptions" [value]="fuel">{{ fuel }}</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="editFuelCapacity">Fuel Capacity (L)</label>
                                <input type="number" formControlName="fuelCapacity" id="editFuelCapacity" class="form-control" step="0.01">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCurrentMileage">Current Mileage *</label>
                                <input type="number" formControlName="currentMileage" id="editCurrentMileage" class="form-control" step="0.01">
                            </div>

                            <div class="form-group">
                                <label for="editFuelLevel">Fuel Level (%) *</label>
                                <input type="number" formControlName="fuelLevel" id="editFuelLevel" class="form-control" min="0" max="100">
                            </div>
                        </div>
                    </div>

                    <!-- Documentation -->
                    <div class="form-section">
                        <h4>Documentation</h4>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editRegistrationExpiry">Registration Expiry *</label>
                                <input type="date" formControlName="registrationExpiry" id="editRegistrationExpiry" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="editInsuranceExpiry">Insurance Expiry *</label>
                                <input type="date" formControlName="insuranceExpiry" id="editInsuranceExpiry" class="form-control">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="editInsurancePolicy">Insurance Policy Number</label>
                            <input type="text" formControlName="insurancePolicy" id="editInsurancePolicy" class="form-control">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="editPurchaseDate">Purchase Date</label>
                                <input type="date" formControlName="purchaseDate" id="editPurchaseDate" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="editPurchasePrice">Purchase Price</label>
                                <input type="number" formControlName="purchasePrice" id="editPurchasePrice" class="form-control" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="cancel-btn" (click)="hideEditForm()">Cancel</button>
                    <button type="submit" class="submit-btn" [disabled]="editForm.invalid || isLoading">
                        {{ isLoading ? 'Updating...' : 'Update Vehicle' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Vehicles Table -->
    <div class="table-container" *ngIf="!isLoading">
        <div class="table-header">
            <h3>Vehicles ({{ filteredVehicles.length }})</h3>
        </div>

        <div *ngIf="filteredVehicles.length === 0" class="no-data">
            <p>No vehicles found matching your criteria.</p>
        </div>

        <table *ngIf="filteredVehicles.length > 0" class="vehicles-table">
            <thead>
                <tr>
                    <th>Vehicle</th>
                    <th>License Plate</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Assigned Driver</th>
                    <th>Fuel Level</th>
                    <th>Mileage</th>
                    <th>Registration</th>
                    <th>Insurance</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let vehicle of filteredVehicles" class="vehicle-row">
                    <td class="vehicle-info">
                        <div class="vehicle-name">{{ vehicle.make }} {{ vehicle.model }}</div>
                        <div class="vehicle-year">{{ vehicle.year }} • {{ vehicle.color || 'No color' }}</div>
                        <div class="fuel-type">{{ vehicle.fuelType }}</div>
                    </td>

                    <td class="license-plate">
                        <span class="plate-number">{{ vehicle.licensePlate }}</span>
                    </td>

                    <td class="category">
                        {{ getCategoryName(vehicle.categoryId) }}
                    </td>

                    <td class="status">
                        <span class="status-badge" [ngClass]="getStatusBadgeClass(vehicle.status)">
                            {{ vehicle.status }}
                        </span>
                    </td>

                    <td class="driver-assignment">
                        <div *ngIf="vehicle.currentDriverId; else unassigned" class="driver-assigned">
                            {{ getCurrentDriverName(vehicle) }}
                        </div>
                        <ng-template #unassigned>
                            <span class="unassigned">Unassigned</span>
                        </ng-template>
                    </td>

                    <td class="fuel-level">
                        <div class="fuel-container">
                            <div class="fuel-bar">
                                <div class="fuel-fill" [style.width.%]="vehicle.fuelLevel"
                                     [ngClass]="{'low-fuel': vehicle.fuelLevel < 25, 'medium-fuel': vehicle.fuelLevel >= 25 && vehicle.fuelLevel < 50}">
                                </div>
                            </div>
                            <span class="fuel-percentage">{{ vehicle.fuelLevel }}%</span>
                        </div>
                    </td>

                    <td class="mileage">
                        {{ vehicle.currentMileage | number:'1.0-0' }} km
                    </td>

                    <td class="registration">
                        <div class="expiry-date"
                             [ngClass]="{'expired': isRegistrationExpired(vehicle), 'expiring': isRegistrationExpiring(vehicle)}">
                            {{ vehicle.registrationExpiry | date:'shortDate' }}
                        </div>
                        <div *ngIf="isRegistrationExpired(vehicle)" class="expiry-warning expired">Expired</div>
                        <div *ngIf="isRegistrationExpiring(vehicle) && !isRegistrationExpired(vehicle)" class="expiry-warning expiring">Expiring Soon</div>
                    </td>

                    <td class="insurance">
                        <div class="expiry-date"
                             [ngClass]="{'expired': isInsuranceExpired(vehicle), 'expiring': isInsuranceExpiring(vehicle)}">
                            {{ vehicle.insuranceExpiry | date:'shortDate' }}
                        </div>
                        <div *ngIf="isInsuranceExpired(vehicle)" class="expiry-warning expired">Expired</div>
                        <div *ngIf="isInsuranceExpiring(vehicle) && !isInsuranceExpired(vehicle)" class="expiry-warning expiring">Expiring Soon</div>
                    </td>

                    <td class="actions">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" (click)="editVehicle(vehicle)" title="Edit Vehicle">
                                ✏️
                            </button>
                            <button class="action-btn delete-btn" (click)="deleteVehicle(vehicle)" title="Delete Vehicle">
                                🗑️
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>