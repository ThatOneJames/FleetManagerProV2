<div class="maintenance-container">

    <div class="page-header">
        <h2>Vehicle Maintenance Management</h2>
        <div class="header-actions">
            <button class="btn btn-secondary"
                    (click)="downloadCSV()"
                    [disabled]="(activeTab === 'tasks' ? filteredTasks : filteredRequests).length === 0">
                📥 Download CSV
            </button>
            <button class="btn btn-primary"
                    (click)="toggleAddForm()"
                    *ngIf="activeTab === 'tasks'">
                {{ showAddForm ? 'Cancel' : '+ Add New Task' }}
            </button>
        </div>
    </div>

    <!-- Success Message -->
    <div *ngIf="successMessage" class="alert alert-success">
        <span class="alert-icon">✓</span>
        {{ successMessage }}
        <button class="close-btn" (click)="successMessage = null">&times;</button>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="alert alert-error">
        <span class="alert-icon">⚠</span>
        {{ errorMessage }}
        <button class="close-btn" (click)="errorMessage = null">&times;</button>
    </div>

    <!-- Statistics Dashboard -->
    <div class="statistics-grid" *ngIf="statistics">
        <div class="stat-card">
            <div class="stat-icon scheduled">📅</div>
            <div class="stat-content">
                <h3>{{ statistics.scheduledTasks }}</h3>
                <p>Scheduled</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon in-progress">🔧</div>
            <div class="stat-content">
                <h3>{{ statistics.inProgressTasks }}</h3>
                <p>In Progress</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon completed">✅</div>
            <div class="stat-content">
                <h3>{{ statistics.completedTasks }}</h3>
                <p>Completed</p>
            </div>
        </div>
        <div class="stat-card alert-card">
            <div class="stat-icon overdue">⚠️</div>
            <div class="stat-content">
                <h3>{{ statistics.overdueTasks }}</h3>
                <p>Overdue</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon cost">💰</div>
            <div class="stat-content">
                <h3>{{ formatCurrency(statistics.totalCost) }}</h3>
                <p>Total Cost</p>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-container">
        <button class="tab-btn"
                [class.active]="activeTab === 'tasks'"
                (click)="switchTab('tasks')">
            🛠️ Scheduled Maintenance ({{ tasks.length }})
        </button>
        <button class="tab-btn"
                [class.active]="activeTab === 'requests'"
                (click)="switchTab('requests')">
            🚨 Inspection Reports ({{ maintenanceRequests.length }})
        </button>
    </div>

    <!-- ==================== SCHEDULED MAINTENANCE TAB ==================== -->
    <div *ngIf="activeTab === 'tasks'">
        <!-- Add/Edit Form WITH VALIDATION -->
        <div class="maintenance-form-card" *ngIf="showAddForm">
            <h3>{{ editingTask ? 'Edit' : 'Add New' }} Maintenance Task</h3>
            <form [formGroup]="maintenanceForm" class="maintenance-form">
                <div class="form-row">
                    <!-- Vehicle -->
                    <div class="form-group">
                        <label>Vehicle *</label>
                        <select formControlName="vehicleId"
                                [class.invalid]="isFieldInvalid(maintenanceForm, 'vehicleId')"
                                [class.valid]="maintenanceForm.get('vehicleId')?.valid && maintenanceForm.get('vehicleId')?.touched">
                            <option value="">Select Vehicle</option>
                            <option *ngFor="let vehicle of vehicles" [value]="vehicle.id">
                                {{ vehicle.make }} {{ vehicle.model }} - {{ vehicle.licensePlate }}
                            </option>
                        </select>
                        <div *ngIf="isFieldInvalid(maintenanceForm, 'vehicleId')" class="error-text">
                            {{ getFieldErrorMessage(maintenanceForm, 'vehicleId') }}
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="form-group">
                        <label>Category *</label>
                        <select formControlName="categoryId"
                                [class.invalid]="isFieldInvalid(maintenanceForm, 'categoryId')"
                                [class.valid]="maintenanceForm.get('categoryId')?.valid && maintenanceForm.get('categoryId')?.touched">
                            <option [value]="0">Select Category</option>
                            <option *ngFor="let category of categories" [value]="category.id">
                                {{ category.name }}
                            </option>
                        </select>
                        <div *ngIf="isFieldInvalid(maintenanceForm, 'categoryId')" class="error-text">
                            {{ getFieldErrorMessage(maintenanceForm, 'categoryId') }}
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <!-- Task Type -->
                    <div class="form-group">
                        <label>Task Type *</label>
                        <input formControlName="taskType"
                               placeholder="e.g., Oil Change, Tire Rotation"
                               [class.invalid]="isFieldInvalid(maintenanceForm, 'taskType')"
                               [class.valid]="maintenanceForm.get('taskType')?.valid && maintenanceForm.get('taskType')?.touched" />
                        <div *ngIf="isFieldInvalid(maintenanceForm, 'taskType')" class="error-text">
                            {{ getFieldErrorMessage(maintenanceForm, 'taskType') }}
                        </div>
                        <div class="field-hint">3-100 characters</div>
                    </div>

                    <!-- Scheduled Date -->
                    <div class="form-group">
                        <label>Scheduled Date *</label>
                        <input formControlName="scheduledDate"
                               type="date"
                               [class.invalid]="isFieldInvalid(maintenanceForm, 'scheduledDate')"
                               [class.valid]="maintenanceForm.get('scheduledDate')?.valid && maintenanceForm.get('scheduledDate')?.touched" />
                        <div *ngIf="isFieldInvalid(maintenanceForm, 'scheduledDate')" class="error-text">
                            {{ getFieldErrorMessage(maintenanceForm, 'scheduledDate') }}
                        </div>
                        <div class="field-hint">Must be today or a future date</div>
                    </div>
                </div>

                <div class="form-row">
                    <!-- Priority -->
                    <div class="form-group">
                        <label>Priority *</label>
                        <select formControlName="priority">
                            <option *ngFor="let priority of priorityOptions" [value]="priority">
                                {{ priority }}
                            </option>
                        </select>
                    </div>

                    <!-- Status -->
                    <div class="form-group">
                        <label>Status *</label>
                        <select formControlName="status">
                            <option *ngFor="let status of statusOptions" [value]="status">
                                {{ status }}
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Description -->
                <div class="form-group full-width">
                    <label>Description *</label>
                    <textarea formControlName="description"
                              placeholder="Detailed description of the maintenance task"
                              rows="3"
                              [class.invalid]="isFieldInvalid(maintenanceForm, 'description')"
                              [class.valid]="maintenanceForm.get('description')?.valid && maintenanceForm.get('description')?.touched"></textarea>
                    <div *ngIf="isFieldInvalid(maintenanceForm, 'description')" class="error-text">
                        {{ getFieldErrorMessage(maintenanceForm, 'description') }}
                    </div>
                    <div class="field-hint">10-1000 characters - Provide comprehensive details</div>
                </div>

                <div class="form-row">
                    <!-- Estimated Cost -->
                    <div class="form-group">
                        <label>Estimated Cost</label>
                        <input formControlName="estimatedCost"
                               type="number"
                               step="0.01"
                               placeholder="0.00"
                               [class.invalid]="isFieldInvalid(maintenanceForm, 'estimatedCost')"
                               [class.valid]="maintenanceForm.get('estimatedCost')?.valid && maintenanceForm.get('estimatedCost')?.touched" />
                        <div *ngIf="isFieldInvalid(maintenanceForm, 'estimatedCost')" class="error-text">
                            {{ getFieldErrorMessage(maintenanceForm, 'estimatedCost') }}
                        </div>
                    </div>

                    <!-- Service Provider -->
                    <div class="form-group">
                        <label>Service Provider</label>
                        <input formControlName="serviceProvider"
                               placeholder="e.g., ABC Auto Shop"
                               [class.invalid]="isFieldInvalid(maintenanceForm, 'serviceProvider')"
                               [class.valid]="maintenanceForm.get('serviceProvider')?.valid && maintenanceForm.get('serviceProvider')?.touched" />
                        <div *ngIf="isFieldInvalid(maintenanceForm, 'serviceProvider')" class="error-text">
                            {{ getFieldErrorMessage(maintenanceForm, 'serviceProvider') }}
                        </div>
                    </div>
                </div>

                <!-- Assigned To -->
                <div class="form-group">
                    <label>Assigned To</label>
                    <input formControlName="assignedTo"
                           placeholder="Technician name"
                           [class.invalid]="isFieldInvalid(maintenanceForm, 'assignedTo')"
                           [class.valid]="maintenanceForm.get('assignedTo')?.valid && maintenanceForm.get('assignedTo')?.touched" />
                    <div *ngIf="isFieldInvalid(maintenanceForm, 'assignedTo')" class="error-text">
                        {{ getFieldErrorMessage(maintenanceForm, 'assignedTo') }}
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" (click)="toggleAddForm()">
                        Cancel
                    </button>
                    <button type="button"
                            class="btn btn-primary"
                            (click)="editingTask ? updateTask() : addTask()"
                            [disabled]="loading">
                        {{ loading ? 'Saving...' : (editingTask ? 'Update Task' : 'Create Task') }}
                    </button>
                </div>
            </form>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <h3>Filters</h3>
            <div class="filters">
                <select [(ngModel)]="filterVehicle" (change)="onFilterChange()">
                    <option value="">All Vehicles</option>
                    <option *ngFor="let vehicle of vehicles" [value]="vehicle.id">
                        {{ vehicle.make }} {{ vehicle.model }}
                    </option>
                </select>

                <select [(ngModel)]="filterStatus" (change)="onFilterChange()">
                    <option value="">All Statuses</option>
                    <option *ngFor="let status of statusOptions" [value]="status">
                        {{ status }}
                    </option>
                </select>

                <select [(ngModel)]="filterPriority" (change)="onFilterChange()">
                    <option value="">All Priorities</option>
                    <option *ngFor="let priority of priorityOptions" [value]="priority">
                        {{ priority }}
                    </option>
                </select>

                <button class="btn btn-secondary" (click)="clearFilters()">
                    Clear Filters
                </button>
            </div>
        </div>

        <!-- Tasks List -->
        <div class="maintenance-list">
            <h3>Maintenance Tasks ({{ filteredTasks.length }})</h3>

            <div *ngIf="loading && !showAddForm" class="loading">
                <p>Loading maintenance tasks...</p>
            </div>

            <div *ngIf="filteredTasks.length === 0 && !loading" class="no-data">
                <p>No maintenance tasks found. Create your first task to get started!</p>
            </div>

            <div class="task-grid" *ngIf="!loading || showAddForm">
                <div *ngFor="let task of filteredTasks"
                     class="task-card"
                     [class.overdue]="task.status === 'Overdue'">
                    <div class="task-header">
                        <div>
                            <h4>{{ task.taskType }}</h4>
                            <p class="vehicle-info">{{ getVehicleDisplay(task) }}</p>
                        </div>
                        <div class="task-badges">
                            <span class="badge priority" [ngClass]="getPriorityClass(task.priority)">
                                {{ task.priority }}
                            </span>
                            <span class="badge status" [ngClass]="getStatusClass(task.status)">
                                {{ task.status }}
                            </span>
                        </div>
                    </div>

                    <div class="task-body">
                        <p class="description">{{ task.description }}</p>

                        <div class="task-details">
                            <div class="detail-item">
                                <span class="label">Category:</span>
                                <span>{{ getCategoryName(task.categoryId) }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Scheduled:</span>
                                <span>{{ formatDate(task.scheduledDate) }}</span>
                            </div>
                            <div class="detail-item" *ngIf="task.estimatedCost">
                                <span class="label">Estimated Cost:</span>
                                <span>{{ formatCurrency(task.estimatedCost) }}</span>
                            </div>
                            <div class="detail-item" *ngIf="task.actualCost">
                                <span class="label">Actual Cost:</span>
                                <span>{{ formatCurrency(task.actualCost) }}</span>
                            </div>
                            <div class="detail-item" *ngIf="task.serviceProvider">
                                <span class="label">Provider:</span>
                                <span>{{ task.serviceProvider }}</span>
                            </div>
                            <div class="detail-item" *ngIf="task.assignedTo">
                                <span class="label">Assigned To:</span>
                                <span>{{ task.assignedTo }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-actions">
                        <button class="btn btn-sm btn-success"
                                (click)="completeTask(task)"
                                *ngIf="task.status !== 'Completed' && task.status !== 'Cancelled'">
                            ✓ Complete
                        </button>
                        <button class="btn btn-sm btn-secondary" (click)="editTask(task)">
                            ✏️ Edit
                        </button>
                        <button class="btn btn-sm btn-danger" (click)="deleteTask(task.id!)">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== INSPECTION REPORTS TAB ==================== -->
    <div *ngIf="activeTab === 'requests'">
        <!-- Filters for Requests -->
        <div class="filters-section">
            <h3>Filters</h3>
            <div class="filters">
                <select [(ngModel)]="filterRequestVehicle" (change)="onRequestFilterChange()">
                    <option value="">All Vehicles</option>
                    <option *ngFor="let vehicle of vehicles" [value]="vehicle.id">
                        {{ vehicle.make }} {{ vehicle.model }}
                    </option>
                </select>

                <select [(ngModel)]="filterRequestStatus" (change)="onRequestFilterChange()">
                    <option value="">All Statuses</option>
                    <option *ngFor="let status of requestStatusOptions" [value]="status">
                        {{ status }}
                    </option>
                </select>

                <select [(ngModel)]="filterRequestSeverity" (change)="onRequestFilterChange()">
                    <option value="">All Severities</option>
                    <option *ngFor="let severity of severityOptions" [value]="severity">
                        {{ severity }}
                    </option>
                </select>

                <button class="btn btn-secondary" (click)="clearFilters()">
                    Clear Filters
                </button>
            </div>
        </div>

        <!-- Requests List -->
        <div class="maintenance-list">
            <h3>Pre-Trip Inspection Reports ({{ filteredRequests.length }})</h3>

            <div *ngIf="loading" class="loading">
                <p>Loading maintenance requests...</p>
            </div>

            <div *ngIf="filteredRequests.length === 0 && !loading" class="no-data">
                <p>No maintenance requests from pre-trip inspections yet.</p>
            </div>

            <div class="task-grid" *ngIf="!loading">
                <div *ngFor="let request of filteredRequests"
                     class="task-card request-card"
                     [class.critical]="request.issueSeverity === 'Critical'">
                    <div class="task-header">
                        <div>
                            <h4>{{ request.issueType }}</h4>
                            <p class="vehicle-info">{{ getRequestVehicleDisplay(request) }}</p>
                            <p class="driver-info">👤 {{ request.driver?.name || request.reportedBy }}</p>
                        </div>
                        <div class="task-badges">
                            <span class="badge severity" [ngClass]="getSeverityClass(request.issueSeverity)">
                                {{ request.issueSeverity }}
                            </span>
                            <span class="badge status" [ngClass]="getStatusClass(request.status || 'Pending')">
                                {{ request.status || 'Pending' }}
                            </span>
                        </div>
                    </div>

                    <div class="task-body">
                        <p class="description">{{ request.description }}</p>

                        <div class="task-details">
                            <div class="detail-item">
                                <span class="label">Reported:</span>
                                <span>{{ formatDate(request.reportedDate) }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Priority:</span>
                                <span>{{ request.priority }}</span>
                            </div>
                        </div>

                        <div class="request-assignment" *ngIf="request.assignedMechanic || request.route">
                            <div class="assignment-row" *ngIf="request.assignedMechanic">
                                <span class="assignment-label">Assigned To:</span>
                                <span class="assignment-value">{{ request.assignedMechanic }}</span>
                            </div>
                            <div class="assignment-row" *ngIf="request.route">
                                <span class="assignment-label">Route:</span>
                                <span class="assignment-value">{{ request.route.name }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="task-actions">
                        <button class="btn btn-sm btn-primary" (click)="viewRequestDetails(request)">
                            👁️ View Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div class="modal-overlay" *ngIf="showRequestDetails && selectedRequest">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Maintenance Request Details</h3>
                <button class="close-btn" (click)="closeRequestDetails()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="request-details">
                    <div class="detail-section">
                        <h4>Vehicle Information</h4>
                        <p><strong>Vehicle:</strong> {{ getRequestVehicleDisplay(selectedRequest) }}</p>
                        <p><strong>Reported By:</strong> {{ selectedRequest.driver?.name || selectedRequest.reportedBy }}</p>
                        <p><strong>Date Reported:</strong> {{ formatDate(selectedRequest.reportedDate) }}</p>
                    </div>

                    <div class="detail-section">
                        <h4>Issue Details</h4>
                        <p><strong>Type:</strong> {{ selectedRequest.issueType }}</p>
                        <p>
                            <strong>Severity:</strong>
                            <span class="badge severity" [ngClass]="getSeverityClass(selectedRequest.issueSeverity)">
                                {{ selectedRequest.issueSeverity }}
                            </span>
                        </p>
                        <p><strong>Priority:</strong> {{ selectedRequest.priority }}</p>
                        <p>
                            <strong>Status:</strong>
                            <span class="badge status" [ngClass]="getStatusClass(selectedRequest.status || 'Pending')">
                                {{ selectedRequest.status || 'Pending' }}
                            </span>
                        </p>
                    </div>

                    <div class="detail-section" *ngIf="selectedRequest.assignedMechanic || selectedRequest.route">
                        <h4>Assignment & Route Details</h4>
                        <p *ngIf="selectedRequest.assignedMechanic">
                            <strong>Assigned Mechanic:</strong> {{ selectedRequest.assignedMechanic }}
                        </p>
                        <p *ngIf="selectedRequest.route">
                            <strong>Route:</strong> {{ selectedRequest.route.name }}
                        </p>
                    </div>

                    <div class="detail-section">
                        <h4>Description</h4>
                        <p class="description-text">{{ selectedRequest.description }}</p>
                    </div>

                    <div class="detail-section" *ngIf="selectedRequest.repairNotes">
                        <h4>Repair Notes</h4>
                        <p class="description-text">{{ selectedRequest.repairNotes }}</p>
                    </div>

                    <div class="detail-section">
                        <h4>Update Status</h4>
                        <div class="status-update-form">
                            <select #statusSelect class="form-control">
                                <option value="Pending">Pending</option>
                                <option value="InProgress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                            <input #mechanicInput
                                   type="text"
                                   placeholder="Assigned Mechanic"
                                   class="form-control"
                                   [value]="selectedRequest.assignedMechanic || ''" />
                            <textarea #notesInput
                                      placeholder="Repair notes..."
                                      rows="3"
                                      class="form-control"></textarea>
                            <button class="btn btn-primary"
                                    (click)="updateRequestStatus(selectedRequest.id!, statusSelect.value, mechanicInput.value, notesInput.value)">
                                Update Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
