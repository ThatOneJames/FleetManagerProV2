<div class="system-management-container">
    <div class="page-header">
        <div class="header-content">
            <h1>
                <mat-icon>settings</mat-icon>
                System Management
            </h1>
            <p class="subtitle">User management and system configuration</p>
        </div>
    </div>

    <mat-card>
        <mat-card-header>
            <mat-card-title>System Management</mat-card-title>
        </mat-card-header>

        <p class="card-subtitle">Manage users and permissions, receive notifications, and system reports</p>

        <mat-card-content>
            <mat-tab-group [(selectedIndex)]="selectedTabIndex" animationDuration="300ms">

                <!-- USER MANAGEMENT TAB -->
                <mat-tab label="User Management">
                    <div class="tab-content">
                        <div class="section-header">
                            <h2>System Users</h2>
                            <button mat-raised-button color="primary" (click)="toggleUserForm()">
                                <mat-icon>person_add</mat-icon>
                                Add User
                            </button>
                        </div>

                        <!-- ENHANCED USER FORM WITH VALIDATION -->
                        <div *ngIf="showUserForm" class="user-form-section">
                            <h3>{{ editingUser ? 'Edit User' : 'Add New User' }}</h3>
                            <form [formGroup]="userForm" (ngSubmit)="saveUser()">
                                <div class="form-grid">
                                    <!-- Name -->
                                    <mat-form-field appearance="outline">
                                        <mat-label>Name *</mat-label>
                                        <input matInput formControlName="name" placeholder="Full Name">
                                        <mat-icon matPrefix>person</mat-icon>
                                        <mat-error *ngIf="isFieldInvalid(userForm, 'name')">
                                            {{ getFieldErrorMessage(userForm, 'name') }}
                                        </mat-error>
                                        <mat-hint>2-100 characters, letters only</mat-hint>
                                    </mat-form-field>

                                    <!-- Email -->
                                    <mat-form-field appearance="outline">
                                        <mat-label>Email *</mat-label>
                                        <input matInput type="email" formControlName="email" placeholder="email@example.com">
                                        <mat-icon matPrefix>email</mat-icon>
                                        <mat-error *ngIf="isFieldInvalid(userForm, 'email')">
                                            {{ getFieldErrorMessage(userForm, 'email') }}
                                        </mat-error>
                                    </mat-form-field>

                                    <!-- Phone -->
                                    <mat-form-field appearance="outline">
                                        <mat-label>Phone</mat-label>
                                        <input matInput formControlName="phone" placeholder="+63 912 345 6789">
                                        <mat-icon matPrefix>phone</mat-icon>
                                        <mat-error *ngIf="isFieldInvalid(userForm, 'phone')">
                                            {{ getFieldErrorMessage(userForm, 'phone') }}
                                        </mat-error>
                                        <mat-hint>Optional - Format: +63 912 345 6789</mat-hint>
                                    </mat-form-field>

                                    <!-- Role -->
                                    <mat-form-field appearance="outline">
                                        <mat-label>Role *</mat-label>
                                        <mat-select formControlName="role">
                                            <mat-option *ngFor="let role of roles" [value]="role.id">
                                                {{ role.name }}
                                            </mat-option>
                                        </mat-select>
                                        <mat-icon matPrefix>admin_panel_settings</mat-icon>
                                        <mat-error *ngIf="isFieldInvalid(userForm, 'role')">
                                            {{ getFieldErrorMessage(userForm, 'role') }}
                                        </mat-error>
                                    </mat-form-field>

                                    <!-- Status -->
                                    <mat-form-field appearance="outline">
                                        <mat-label>Status *</mat-label>
                                        <mat-select formControlName="status">
                                            <mat-option *ngFor="let status of statusOptions" [value]="status">
                                                {{ status }}
                                            </mat-option>
                                        </mat-select>
                                        <mat-icon matPrefix>toggle_on</mat-icon>
                                        <mat-error *ngIf="isFieldInvalid(userForm, 'status')">
                                            {{ getFieldErrorMessage(userForm, 'status') }}
                                        </mat-error>
                                    </mat-form-field>

                                    <!-- Password (only for new users) -->
                                    <mat-form-field appearance="outline" *ngIf="!editingUser">
                                        <mat-label>Password *</mat-label>
                                        <input matInput type="password" formControlName="password" placeholder="Minimum 6 characters">
                                        <mat-icon matPrefix>lock</mat-icon>
                                        <mat-error *ngIf="isFieldInvalid(userForm, 'password')">
                                            {{ getFieldErrorMessage(userForm, 'password') }}
                                        </mat-error>
                                        <mat-hint>Min 6 chars, must contain letters and numbers</mat-hint>
                                    </mat-form-field>

                                    <!-- Address -->
                                    <mat-form-field appearance="outline" class="full-width">
                                        <mat-label>Address</mat-label>
                                        <textarea matInput formControlName="address" rows="2" placeholder="Complete Address"></textarea>
                                        <mat-icon matPrefix>location_on</mat-icon>
                                        <mat-error *ngIf="isFieldInvalid(userForm, 'address')">
                                            {{ getFieldErrorMessage(userForm, 'address') }}
                                        </mat-error>
                                        <mat-hint>Optional - Max 500 characters</mat-hint>
                                    </mat-form-field>
                                </div>

                                <div class="form-actions">
                                    <button mat-raised-button color="primary" type="submit" [disabled]="savingUser">
                                        <mat-icon>{{ editingUser ? 'save' : 'add' }}</mat-icon>
                                        {{ savingUser ? 'Saving...' : (editingUser ? 'Update User' : 'Create User') }}
                                    </button>
                                    <button mat-stroked-button type="button" (click)="cancelEditUser()">
                                        <mat-icon>close</mat-icon>
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Users Table -->
                        <div class="table-container">
                            <div *ngIf="loading" class="loading-state">
                                <mat-spinner></mat-spinner>
                            </div>

                            <div *ngIf="!loading && users.length === 0" class="empty-state">
                                <mat-icon>people_outline</mat-icon>
                                <p>No users found</p>
                            </div>

                            <table mat-table [dataSource]="users" class="users-table" *ngIf="!loading && users.length > 0">
                                <ng-container matColumnDef="name">
                                    <th mat-header-cell *matHeaderCellDef>Name</th>
                                    <td mat-cell *matCellDef="let user">{{ user.name }}</td>
                                </ng-container>

                                <ng-container matColumnDef="email">
                                    <th mat-header-cell *matHeaderCellDef>Email</th>
                                    <td mat-cell *matCellDef="let user">{{ user.email }}</td>
                                </ng-container>

                                <ng-container matColumnDef="role">
                                    <th mat-header-cell *matHeaderCellDef>Role</th>
                                    <td mat-cell *matCellDef="let user">
                                        <span class="role-badge" [ngClass]="getRoleBadgeClass(user.role)">
                                            {{ user.role }}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="status">
                                    <th mat-header-cell *matHeaderCellDef>Status</th>
                                    <td mat-cell *matCellDef="let user">
                                        <span class="status-badge" [ngClass]="'status-' + user.status.toLowerCase()">
                                            {{ user.status }}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="actions">
                                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                                    <td mat-cell *matCellDef="let user">
                                        <button mat-icon-button (click)="editUser(user)" matTooltip="Edit">
                                            <mat-icon>edit</mat-icon>
                                        </button>
                                        <button mat-icon-button (click)="openChangePasswordModal(user)" matTooltip="Change Password">
                                            <mat-icon>lock_reset</mat-icon>
                                        </button>
                                        <button mat-icon-button (click)="toggleUserStatus(user)"
                                                [matTooltip]="user.status === 'Active' ? 'Deactivate' : 'Activate'">
                                            <mat-icon>{{ user.status === 'Active' ? 'block' : 'check_circle' }}</mat-icon>
                                        </button>
                                        <button mat-icon-button (click)="deleteUser(user)" matTooltip="Delete">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="userColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: userColumns;"></tr>
                            </table>
                        </div>
                    </div>
                </mat-tab>

                <!-- NOTIFICATION HISTORY TAB -->
                <mat-tab label="Notifications">
                    <div class="tab-content">
                        <div class="section-header">
                            <h2>Notification History</h2>
                            <p>System-generated notifications are sent automatically when events occur</p>
                        </div>

                        <div class="subtab-content">
                            <h3>Recent Notifications</h3>

                            <div *ngIf="notifications.length === 0" class="empty-state">
                                <mat-icon>notifications_none</mat-icon>
                                <p>No notifications sent yet</p>
                            </div>

                            <table mat-table [dataSource]="notifications" class="history-table" *ngIf="notifications.length > 0">
                                <ng-container matColumnDef="id">
                                    <th mat-header-cell *matHeaderCellDef>ID</th>
                                    <td mat-cell *matCellDef="let notification">#{{ notification.id }}</td>
                                </ng-container>

                                <ng-container matColumnDef="title">
                                    <th mat-header-cell *matHeaderCellDef>Title</th>
                                    <td mat-cell *matCellDef="let notification">
                                        <strong>{{ notification.title }}</strong>
                                        <br>
                                        <small>{{ notification.message | slice:0:50 }}...</small>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="type">
                                    <th mat-header-cell *matHeaderCellDef>Type</th>
                                    <td mat-cell *matCellDef="let notification">
                                        <span class="type-chip" [ngClass]="'type-' + notification.type.toLowerCase()">
                                            {{ notification.type }}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="recipients">
                                    <th mat-header-cell *matHeaderCellDef>Recipient</th>
                                    <td mat-cell *matCellDef="let notification">{{ getUserName(notification.userId) }}</td>
                                </ng-container>

                                <ng-container matColumnDef="createdAt">
                                    <th mat-header-cell *matHeaderCellDef>Date</th>
                                    <td mat-cell *matCellDef="let notification">{{ formatDate(notification.createdAt) }}</td>
                                </ng-container>

                                <ng-container matColumnDef="status">
                                    <th mat-header-cell *matHeaderCellDef>Status</th>
                                    <td mat-cell *matCellDef="let notification">
                                        <span class="status-badge" [ngClass]="getStatusBadgeClass(notification)">
                                            {{ getStatusText(notification) }}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="actions">
                                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                                    <td mat-cell *matCellDef="let notification">
                                        <button mat-icon-button (click)="markAsRead(notification)"
                                                matTooltip="Mark as Read"
                                                [disabled]="notification.isRead">
                                            <mat-icon>{{ notification.isRead ? 'check_circle' : 'check_circle_outline' }}</mat-icon>
                                        </button>
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: historyColumns;"></tr>
                            </table>
                        </div>
                    </div>
                </mat-tab>

                <!-- REPORTS TAB -->
                <mat-tab label="Reports">
                    <div class="tab-content">
                        <div class="section-header">
                            <h2>System Reports</h2>
                            <p>Download attendance and trip reports</p>
                        </div>

                        <div *ngIf="reports.length === 0" class="empty-state">
                            <mat-icon>description</mat-icon>
                            <p>No reports generated yet</p>
                        </div>

                        <table mat-table [dataSource]="reports" class="reports-table" *ngIf="reports.length > 0">
                            <ng-container matColumnDef="reportName">
                                <th mat-header-cell *matHeaderCellDef>Report Name</th>
                                <td mat-cell *matCellDef="let report">{{ report.reportName }}</td>
                            </ng-container>

                            <ng-container matColumnDef="type">
                                <th mat-header-cell *matHeaderCellDef>Type</th>
                                <td mat-cell *matCellDef="let report">{{ report.type }}</td>
                            </ng-container>

                            <ng-container matColumnDef="generatedDate">
                                <th mat-header-cell *matHeaderCellDef>Generated Date</th>
                                <td mat-cell *matCellDef="let report">{{ formatDate(report.generatedDate) }}</td>
                            </ng-container>

                            <ng-container matColumnDef="size">
                                <th mat-header-cell *matHeaderCellDef>Size</th>
                                <td mat-cell *matCellDef="let report">{{ report.size }}</td>
                            </ng-container>

                            <ng-container matColumnDef="format">
                                <th mat-header-cell *matHeaderCellDef>Format</th>
                                <td mat-cell *matCellDef="let report">{{ report.format }}</td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                <td mat-cell *matCellDef="let report">
                                    <button mat-icon-button (click)="downloadReport(report)" matTooltip="Download">
                                        <mat-icon>download</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="reportColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: reportColumns;"></tr>
                        </table>
                    </div>
                </mat-tab>

            </mat-tab-group>
        </mat-card-content>
    </mat-card>

    <!-- ENHANCED CHANGE PASSWORD MODAL WITH VALIDATION -->
    <div class="modal-overlay" *ngIf="showChangePasswordModal" (click)="closeChangePasswordModal()">
        <mat-card class="change-password-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>
                    <mat-icon>lock_reset</mat-icon>
                    Change Password for {{ selectedUserForPasswordChange?.name }}
                </h2>
                <button mat-icon-button (click)="closeChangePasswordModal()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <form [formGroup]="changePasswordForm" (ngSubmit)="changeUserPassword()">
                <!-- New Password -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>New Password *</mat-label>
                    <input matInput type="password" formControlName="newPassword" placeholder="Minimum 6 characters">
                    <mat-icon matPrefix>lock</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(changePasswordForm, 'newPassword')">
                        {{ getFieldErrorMessage(changePasswordForm, 'newPassword') }}
                    </mat-error>
                    <mat-hint>Min 6 chars, must contain letters and numbers</mat-hint>
                </mat-form-field>

                <!-- Confirm Password -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Confirm New Password *</mat-label>
                    <input matInput type="password" formControlName="confirmPassword" placeholder="Re-enter password">
                    <mat-icon matPrefix>lock</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(changePasswordForm, 'confirmPassword')">
                        {{ getFieldErrorMessage(changePasswordForm, 'confirmPassword') }}
                    </mat-error>
                    <mat-error *ngIf="changePasswordForm.hasError('passwordMismatch') && changePasswordForm.get('confirmPassword')?.touched">
                        Passwords do not match
                    </mat-error>
                </mat-form-field>

                <div class="modal-actions">
                    <button mat-button type="button" (click)="closeChangePasswordModal()">
                        Cancel
                    </button>
                    <button mat-raised-button color="primary" type="submit">
                        <mat-icon>check</mat-icon>
                        Change Password
                    </button>
                </div>
            </form>
        </mat-card>
    </div>
</div>
