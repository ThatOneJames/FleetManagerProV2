<div class="system-management-container">
    <div class="page-header">
        <div class="header-content">
            <h1>
                <mat-icon>settings</mat-icon>
                System Management
            </h1>
            <p class="subtitle">User management and system configuration</p>
        </div>
    </div>

    <mat-card>
        <mat-card-header>
            <mat-card-title>System Management</mat-card-title>
            <p class="card-subtitle">Manage users, permissions, notifications, and system reports</p>
        </mat-card-header>

        <mat-card-content>
            <mat-tab-group [(selectedIndex)]="selectedTabIndex" animationDuration="300ms">

                <mat-tab label="User Management">
                    <div class="tab-content">
                        <div class="section-header">
                            <h2>System Users</h2>
                            <button mat-raised-button color="primary" (click)="toggleUserForm()">
                                <mat-icon>person_add</mat-icon>
                                Add User
                            </button>
                        </div>

                        <div *ngIf="showUserForm" class="user-form-section">
                            <h3>{{ editingUser ? 'Edit User' : 'Add New User' }}</h3>
                            <form [formGroup]="userForm" (ngSubmit)="saveUser()">
                                <div class="form-grid">
                                    <mat-form-field appearance="outline">
                                        <mat-label>Name</mat-label>
                                        <input matInput formControlName="name" placeholder="Full Name">
                                        <mat-error *ngIf="userForm.get('name')?.hasError('required')">Name is required</mat-error>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline">
                                        <mat-label>Email</mat-label>
                                        <input matInput type="email" formControlName="email" placeholder="email@example.com">
                                        <mat-error *ngIf="userForm.get('email')?.hasError('required')">Email is required</mat-error>
                                        <mat-error *ngIf="userForm.get('email')?.hasError('email')">Invalid email format</mat-error>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline">
                                        <mat-label>Phone</mat-label>
                                        <input matInput formControlName="phone" placeholder="+63 912 345 6789">
                                    </mat-form-field>

                                    <mat-form-field appearance="outline">
                                        <mat-label>Role</mat-label>
                                        <mat-select formControlName="role">
                                            <mat-option *ngFor="let role of roles" [value]="role.id">
                                                {{ role.name }}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline">
                                        <mat-label>Status</mat-label>
                                        <mat-select formControlName="status">
                                            <mat-option *ngFor="let status of statusOptions" [value]="status">
                                                {{ status }}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" *ngIf="!editingUser">
                                        <mat-label>Password</mat-label>
                                        <input matInput type="password" formControlName="password" placeholder="Minimum 6 characters">
                                        <mat-error *ngIf="userForm.get('password')?.hasError('required')">Password is required</mat-error>
                                        <mat-error *ngIf="userForm.get('password')?.hasError('minlength')">Minimum 6 characters</mat-error>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" class="full-width">
                                        <mat-label>Address</mat-label>
                                        <textarea matInput formControlName="address" rows="2" placeholder="Complete Address"></textarea>
                                    </mat-form-field>
                                </div>

                                <div class="form-actions">
                                    <button mat-raised-button color="primary" type="submit" [disabled]="savingUser || userForm.invalid">
                                        <mat-icon>{{ editingUser ? 'save' : 'add' }}</mat-icon>
                                        {{ savingUser ? 'Saving...' : (editingUser ? 'Update User' : 'Create User') }}
                                    </button>
                                    <button mat-stroked-button type="button" (click)="cancelEditUser()">
                                        <mat-icon>close</mat-icon>
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="table-container">
                            <div *ngIf="loading" class="loading-state">
                                <mat-spinner></mat-spinner>
                            </div>

                            <div *ngIf="!loading && users.length === 0" class="empty-state">
                                <mat-icon>people_outline</mat-icon>
                                <p>No users found</p>
                            </div>

                            <table mat-table [dataSource]="users" class="users-table" *ngIf="!loading && users.length > 0">
                                <ng-container matColumnDef="name">
                                    <th mat-header-cell *matHeaderCellDef>Name</th>
                                    <td mat-cell *matCellDef="let user">{{ user.name }}</td>
                                </ng-container>

                                <ng-container matColumnDef="email">
                                    <th mat-header-cell *matHeaderCellDef>Email</th>
                                    <td mat-cell *matCellDef="let user">{{ user.email }}</td>
                                </ng-container>

                                <ng-container matColumnDef="role">
                                    <th mat-header-cell *matHeaderCellDef>Role</th>
                                    <td mat-cell *matCellDef="let user">
                                        <span class="role-badge" [ngClass]="getRoleBadgeClass(user.role)">
                                            {{ user.role }}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="status">
                                    <th mat-header-cell *matHeaderCellDef>Status</th>
                                    <td mat-cell *matCellDef="let user">
                                        <span class="status-badge" [ngClass]="'status-' + user.status.toLowerCase()">
                                            {{ user.status }}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="actions">
                                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                                    <td mat-cell *matCellDef="let user">
                                        <button mat-icon-button (click)="editUser(user)" matTooltip="Edit">
                                            <mat-icon>edit</mat-icon>
                                        </button>
                                        <button mat-icon-button (click)="toggleUserStatus(user)"
                                                [matTooltip]="user.status === 'Active' ? 'Deactivate' : 'Activate'">
                                            <mat-icon>{{ user.status === 'Active' ? 'block' : 'check_circle' }}</mat-icon>
                                        </button>
                                        <button mat-icon-button (click)="deleteUser(user)" matTooltip="Delete">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="userColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: userColumns;"></tr>
                            </table>
                        </div>
                    </div>
                </mat-tab>

                <mat-tab label="Notifications">
                    <div class="tab-content">
                        <div class="section-header">
                            <h2>Notification System</h2>
                            <p>Automated notification rules and delivery system for Evo Cargo Express</p>
                        </div>

                        <mat-tab-group [(selectedIndex)]="notificationSubTab" class="subtab-group">

                            <mat-tab label="Notification Rules">
                                <div class="subtab-content">
                                    <div class="rule-form-section">
                                        <h3>{{ editingRule ? 'Edit Rule' : 'Create Notification Rule' }}</h3>
                                        <form [formGroup]="notificationRuleForm" (ngSubmit)="saveNotificationRule()">
                                            <div class="form-grid">
                                                <mat-form-field appearance="outline" class="full-width">
                                                    <mat-label>Rule Name</mat-label>
                                                    <input matInput formControlName="name" placeholder="e.g., Trip Assignment Notification">
                                                </mat-form-field>

                                                <mat-form-field appearance="outline">
                                                    <mat-label>Trigger Type</mat-label>
                                                    <mat-select formControlName="triggerType">
                                                        <mat-option *ngFor="let trigger of triggerTypes" [value]="trigger">
                                                            {{ trigger }}
                                                        </mat-option>
                                                    </mat-select>
                                                </mat-form-field>

                                                <mat-form-field appearance="outline">
                                                    <mat-label>Recipients</mat-label>
                                                    <mat-select formControlName="recipientType">
                                                        <mat-option value="all">All Users</mat-option>
                                                        <mat-option value="role">Specific Role(s)</mat-option>
                                                        <mat-option value="specific">Specific User(s)</mat-option>
                                                    </mat-select>
                                                </mat-form-field>

                                                <mat-form-field appearance="outline" class="full-width"
                                                                *ngIf="notificationRuleForm.get('recipientType')?.value === 'role'">
                                                    <mat-label>Select Roles</mat-label>
                                                    <mat-select formControlName="specificRoles" multiple>
                                                        <mat-option *ngFor="let role of roles" [value]="role.id">
                                                            {{ role.name }}
                                                        </mat-option>
                                                    </mat-select>
                                                </mat-form-field>

                                                <mat-form-field appearance="outline" class="full-width"
                                                                *ngIf="notificationRuleForm.get('recipientType')?.value === 'specific'">
                                                    <mat-label>Select Users</mat-label>
                                                    <mat-select formControlName="specificUsers" multiple>
                                                        <mat-option *ngFor="let user of users" [value]="user.id">
                                                            {{ user.name }} ({{ user.email }})
                                                        </mat-option>
                                                    </mat-select>
                                                </mat-form-field>

                                                <mat-form-field appearance="outline" class="full-width">
                                                    <mat-label>Message Template</mat-label>
                                                    <textarea matInput formControlName="conditionText" rows="3"
                                                              placeholder="Message that will be sent when triggered"></textarea>
                                                </mat-form-field>
                                            </div>

                                            <div class="checkbox-group">
                                                <mat-checkbox formControlName="sendEmail">Send Email</mat-checkbox>
                                                <mat-checkbox formControlName="isActive">Active</mat-checkbox>
                                            </div>

                                            <div class="form-actions">
                                                <button mat-raised-button color="primary" type="submit" [disabled]="savingRule || notificationRuleForm.invalid">
                                                    <mat-icon>{{ editingRule ? 'save' : 'add' }}</mat-icon>
                                                    {{ editingRule ? 'Update Rule' : 'Create Rule' }}
                                                </button>
                                                <button mat-stroked-button type="button" (click)="cancelEditRule()" *ngIf="editingRule">
                                                    <mat-icon>close</mat-icon>
                                                    Cancel
                                                </button>
                                            </div>
                                        </form>
                                    </div>

                                    <div class="rules-table-container">
                                        <h3>Existing Rules</h3>

                                        <div *ngIf="notificationRules.length === 0" class="empty-state">
                                            <mat-icon>rule</mat-icon>
                                            <p>No notification rules configured</p>
                                        </div>

                                        <table mat-table [dataSource]="notificationRules" class="rules-table" *ngIf="notificationRules.length > 0">
                                            <ng-container matColumnDef="name">
                                                <th mat-header-cell *matHeaderCellDef>Rule Name</th>
                                                <td mat-cell *matCellDef="let rule">
                                                    <strong>{{ rule.name }}</strong>
                                                    <br>
                                                    <small>Trigger: {{ rule.triggerType }}</small>
                                                </td>
                                            </ng-container>

                                            <ng-container matColumnDef="triggerType">
                                                <th mat-header-cell *matHeaderCellDef>Condition</th>
                                                <td mat-cell *matCellDef="let rule">{{ rule.conditionText || 'N/A' }}</td>
                                            </ng-container>

                                            <ng-container matColumnDef="recipients">
                                                <th mat-header-cell *matHeaderCellDef>Recipients</th>
                                                <td mat-cell *matCellDef="let rule">{{ rule.recipients || 'All' }}</td>
                                            </ng-container>

                                            <ng-container matColumnDef="channels">
                                                <th mat-header-cell *matHeaderCellDef>Channel</th>
                                                <td mat-cell *matCellDef="let rule">
                                                    <span class="channel-chip">
                                                        {{ rule.sendEmail ? 'Email' : 'In-App' }}
                                                    </span>
                                                </td>
                                            </ng-container>

                                            <ng-container matColumnDef="isActive">
                                                <th mat-header-cell *matHeaderCellDef>Status</th>
                                                <td mat-cell *matCellDef="let rule">
                                                    <mat-slide-toggle [checked]="rule.isActive" (change)="toggleRuleStatus(rule)"></mat-slide-toggle>
                                                </td>
                                            </ng-container>

                                            <ng-container matColumnDef="triggeredCount">
                                                <th mat-header-cell *matHeaderCellDef>Triggered</th>
                                                <td mat-cell *matCellDef="let rule">{{ rule.triggeredCount }} times</td>
                                            </ng-container>

                                            <ng-container matColumnDef="lastTriggered">
                                                <th mat-header-cell *matHeaderCellDef>Last Triggered</th>
                                                <td mat-cell *matCellDef="let rule">{{ formatDate(rule.lastTriggered) }}</td>
                                            </ng-container>

                                            <ng-container matColumnDef="actions">
                                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                                <td mat-cell *matCellDef="let rule">
                                                    <button mat-icon-button (click)="editRule(rule)" matTooltip="Edit">
                                                        <mat-icon>edit</mat-icon>
                                                    </button>
                                                    <button mat-icon-button (click)="deleteRule(rule)" matTooltip="Delete">
                                                        <mat-icon>delete</mat-icon>
                                                    </button>
                                                </td>
                                            </ng-container>

                                            <tr mat-header-row *matHeaderRowDef="rulesColumns"></tr>
                                            <tr mat-row *matRowDef="let row; columns: rulesColumns;"></tr>
                                        </table>
                                    </div>
                                </div>
                            </mat-tab>

                            <mat-tab label="Notification History">
                                <div class="subtab-content">
                                    <h3>Recent Notifications</h3>

                                    <div *ngIf="notifications.length === 0" class="empty-state">
                                        <mat-icon>notifications_none</mat-icon>
                                        <p>No notifications sent yet</p>
                                    </div>

                                    <table mat-table [dataSource]="notifications" class="history-table" *ngIf="notifications.length > 0">
                                        <ng-container matColumnDef="id">
                                            <th mat-header-cell *matHeaderCellDef>ID</th>
                                            <td mat-cell *matCellDef="let notification">#{{ notification.id }}</td>
                                        </ng-container>

                                        <ng-container matColumnDef="title">
                                            <th mat-header-cell *matHeaderCellDef>Title</th>
                                            <td mat-cell *matCellDef="let notification">
                                                <strong>{{ notification.title }}</strong>
                                                <br>
                                                <small>{{ notification.message | slice:0:50 }}...</small>
                                            </td>
                                        </ng-container>

                                        <ng-container matColumnDef="type">
                                            <th mat-header-cell *matHeaderCellDef>Type</th>
                                            <td mat-cell *matCellDef="let notification">
                                                <span class="type-chip" [ngClass]="'type-' + notification.type.toLowerCase()">
                                                    {{ notification.type }}
                                                </span>
                                            </td>
                                        </ng-container>

                                        <ng-container matColumnDef="recipients">
                                            <th mat-header-cell *matHeaderCellDef>Recipient</th>
                                            <td mat-cell *matCellDef="let notification">{{ getUserName(notification.userId) }}</td>
                                        </ng-container>

                                        <ng-container matColumnDef="createdAt">
                                            <th mat-header-cell *matHeaderCellDef>Date</th>
                                            <td mat-cell *matCellDef="let notification">{{ formatDate(notification.createdAt) }}</td>
                                        </ng-container>

                                        <ng-container matColumnDef="status">
                                            <th mat-header-cell *matHeaderCellDef>Status</th>
                                            <td mat-cell *matCellDef="let notification">
                                                <span class="status-badge" [ngClass]="getStatusBadgeClass(notification)">
                                                    {{ getStatusText(notification) }}
                                                </span>
                                            </td>
                                        </ng-container>

                                        <ng-container matColumnDef="actions">
                                            <th mat-header-cell *matHeaderCellDef>Actions</th>
                                            <td mat-cell *matCellDef="let notification">
                                                <button mat-icon-button (click)="markAsRead(notification)"
                                                        matTooltip="Mark as Read"
                                                        [disabled]="notification.isRead">
                                                    <mat-icon>{{ notification.isRead ? 'check_circle' : 'check_circle_outline' }}</mat-icon>
                                                </button>
                                            </td>
                                        </ng-container>

                                        <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
                                        <tr mat-row *matRowDef="let row; columns: historyColumns;"></tr>
                                    </table>
                                </div>
                            </mat-tab>

                        </mat-tab-group>
                    </div>
                </mat-tab>

                <mat-tab label="Reports">
                    <div class="tab-content">
                        <div class="section-header">
                            <h2>System Reports</h2>
                            <button mat-raised-button color="primary">
                                <mat-icon>add</mat-icon>
                                Generate Report
                            </button>
                        </div>

                        <div *ngIf="reports.length === 0" class="empty-state">
                            <mat-icon>description</mat-icon>
                            <p>No reports generated yet</p>
                        </div>

                        <table mat-table [dataSource]="reports" class="reports-table" *ngIf="reports.length > 0">
                            <ng-container matColumnDef="reportName">
                                <th mat-header-cell *matHeaderCellDef>Report Name</th>
                                <td mat-cell *matCellDef="let report">{{ report.reportName }}</td>
                            </ng-container>

                            <ng-container matColumnDef="type">
                                <th mat-header-cell *matHeaderCellDef>Type</th>
                                <td mat-cell *matCellDef="let report">{{ report.type }}</td>
                            </ng-container>

                            <ng-container matColumnDef="generatedDate">
                                <th mat-header-cell *matHeaderCellDef>Generated Date</th>
                                <td mat-cell *matCellDef="let report">{{ formatDate(report.generatedDate) }}</td>
                            </ng-container>

                            <ng-container matColumnDef="size">
                                <th mat-header-cell *matHeaderCellDef>Size</th>
                                <td mat-cell *matCellDef="let report">{{ report.size }}</td>
                            </ng-container>

                            <ng-container matColumnDef="format">
                                <th mat-header-cell *matHeaderCellDef>Format</th>
                                <td mat-cell *matCellDef="let report">{{ report.format }}</td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                <td mat-cell *matCellDef="let report">
                                    <button mat-icon-button (click)="downloadReport(report)" matTooltip="Download">
                                        <mat-icon>download</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="reportColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: reportColumns;"></tr>
                        </table>
                    </div>
                </mat-tab>

            </mat-tab-group>
        </mat-card-content>
    </mat-card>
</div>
