<div class="leave-requests-container">
    <div class="header">
        <h2>Leave Management</h2>
        <div class="header-actions">
            <button *ngIf="!isAdminOrManager()"
                    (click)="toggleCreateForm()"
                    class="btn btn-primary">
                + Request Leave
            </button>
            <button *ngIf="isAdminOrManager()"
                    (click)="exportRequests()"
                    class="btn btn-secondary">
                Export Data
            </button>
        </div>
    </div>

    <div *ngIf="loading" class="loading">
        <div class="spinner"></div>
        <span>Loading...</span>
    </div>

    <!-- Success Alert -->
    <div *ngIf="successMessage" class="alert alert-success">
        <span class="alert-icon">✓</span>
        {{ successMessage }}
    </div>

    <!-- Error Alert -->
    <div *ngIf="errorMessage" class="alert alert-error">
        <span class="alert-icon">⚠</span>
        {{ errorMessage }}
    </div>

    <!-- Leave Balance Section -->
    <div *ngIf="!isAdminOrManager() && leaveBalance" class="leave-balance-section">
        <h3>Leave Balance</h3>
        <div class="balance-cards">
            <div class="balance-card">
                <div class="card-header">
                    <h4>Annual Leave</h4>
                </div>
                <div class="card-content">
                    <div class="balance-info">
                        <span class="used">{{ leaveBalance.annual.used }} used</span>
                        <span class="remaining">{{ leaveBalance.annual.remaining }} remaining</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill"
                             [style.width.%]="(leaveBalance.annual.used / leaveBalance.annual.total) * 100">
                        </div>
                    </div>
                    <div class="total">{{ leaveBalance.annual.used }}/{{ leaveBalance.annual.total }} days</div>
                </div>
            </div>

            <div class="balance-card">
                <div class="card-header">
                    <h4>Sick Leave</h4>
                </div>
                <div class="card-content">
                    <div class="balance-info">
                        <span class="used">{{ leaveBalance.sick.used }} used</span>
                        <span class="remaining">{{ leaveBalance.sick.remaining }} remaining</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill"
                             [style.width.%]="(leaveBalance.sick.used / leaveBalance.sick.total) * 100">
                        </div>
                    </div>
                    <div class="total">{{ leaveBalance.sick.used }}/{{ leaveBalance.sick.total }} days</div>
                </div>
            </div>

            <div class="balance-card">
                <div class="card-header">
                    <h4>Personal Leave</h4>
                </div>
                <div class="card-content">
                    <div class="balance-info">
                        <span class="used">{{ leaveBalance.personal.used }} used</span>
                        <span class="remaining">{{ leaveBalance.personal.remaining }} remaining</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill"
                             [style.width.%]="(leaveBalance.personal.used / leaveBalance.personal.total) * 100">
                        </div>
                    </div>
                    <div class="total">{{ leaveBalance.personal.used }}/{{ leaveBalance.personal.total }} days</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ENHANCED CREATE FORM WITH VALIDATION -->
    <div *ngIf="showCreateForm" class="form-overlay">
        <div class="form-container">
            <div class="form-header">
                <h3>Request Leave</h3>
                <button type="button" class="close-btn" (click)="toggleCreateForm()">&times;</button>
            </div>

            <form [formGroup]="createLeaveForm" (ngSubmit)="submitLeaveRequest()">
                <div class="form-grid">
                    <!-- Leave Type -->
                    <div class="form-group">
                        <label for="leaveType">Leave Type *</label>
                        <select formControlName="leaveType"
                                id="leaveType"
                                class="form-control"
                                [class.invalid]="isFieldInvalid(createLeaveForm, 'leaveType')"
                                [class.valid]="createLeaveForm.get('leaveType')?.valid && createLeaveForm.get('leaveType')?.touched">
                            <option [value]="LeaveType.Annual">Annual Leave</option>
                            <option [value]="LeaveType.Sick">Sick Leave</option>
                            <option [value]="LeaveType.Personal">Personal Leave</option>
                            <option [value]="LeaveType.Emergency">Emergency Leave</option>
                            <option [value]="LeaveType.Maternity">Maternity Leave</option>
                            <option [value]="LeaveType.Paternity">Paternity Leave</option>
                            <option [value]="LeaveType.Bereavement">Bereavement Leave</option>
                        </select>
                        <div *ngIf="isFieldInvalid(createLeaveForm, 'leaveType')" class="error-text">
                            {{ getFieldErrorMessage(createLeaveForm, 'leaveType') }}
                        </div>
                    </div>

                    <!-- Start Date -->
                    <div class="form-group">
                        <label for="startDate">Start Date *</label>
                        <input formControlName="startDate"
                               type="date"
                               id="startDate"
                               class="form-control"
                               [class.invalid]="isFieldInvalid(createLeaveForm, 'startDate')"
                               [class.valid]="createLeaveForm.get('startDate')?.valid && createLeaveForm.get('startDate')?.touched"
                               (change)="calculateDays()">
                        <div *ngIf="isFieldInvalid(createLeaveForm, 'startDate')" class="error-text">
                            {{ getFieldErrorMessage(createLeaveForm, 'startDate') }}
                        </div>
                        <div class="field-hint">Must be today or a future date</div>
                    </div>

                    <!-- End Date -->
                    <div class="form-group">
                        <label for="endDate">End Date *</label>
                        <input formControlName="endDate"
                               type="date"
                               id="endDate"
                               class="form-control"
                               [class.invalid]="isFieldInvalid(createLeaveForm, 'endDate')"
                               [class.valid]="createLeaveForm.get('endDate')?.valid && createLeaveForm.get('endDate')?.touched"
                               (change)="calculateDays()">
                        <div *ngIf="isFieldInvalid(createLeaveForm, 'endDate')" class="error-text">
                            {{ getFieldErrorMessage(createLeaveForm, 'endDate') }}
                        </div>
                        <div class="field-hint">Must be on or after start date</div>
                    </div>

                    <!-- Reason -->
                    <div class="form-group full-width">
                        <label for="reason">Reason *</label>
                        <textarea formControlName="reason"
                                  id="reason"
                                  class="form-control"
                                  [class.invalid]="isFieldInvalid(createLeaveForm, 'reason')"
                                  [class.valid]="createLeaveForm.get('reason')?.valid && createLeaveForm.get('reason')?.touched"
                                  rows="4"
                                  placeholder="Please provide a detailed reason for your leave request">
                        </textarea>
                        <div *ngIf="isFieldInvalid(createLeaveForm, 'reason')" class="error-text">
                            {{ getFieldErrorMessage(createLeaveForm, 'reason') }}
                        </div>
                        <div class="field-hint">10-500 characters required</div>
                    </div>
                </div>

                <!-- Form Level Errors -->
                <div *ngIf="getFormErrorMessage(createLeaveForm)" class="alert alert-error">
                    <span class="alert-icon">⚠</span>
                    {{ getFormErrorMessage(createLeaveForm) }}
                </div>

                <div class="form-actions">
                    <button type="submit"
                            [disabled]="loading"
                            class="btn btn-primary">
                        {{ loading ? 'Submitting...' : 'Submit Request' }}
                    </button>
                    <button type="button"
                            (click)="toggleCreateForm()"
                            class="btn btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="search-filters">
            <input [(ngModel)]="searchText"
                   placeholder="Search by driver name or reason..."
                   class="search-input">

            <select [(ngModel)]="filterStatus" class="filter-select">
                <option value="All">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
                <option value="Cancelled">Cancelled</option>
            </select>

            <select [(ngModel)]="filterType" class="filter-select">
                <option value="All">All Types</option>
                <option value="Annual">Annual</option>
                <option value="Sick">Sick</option>
                <option value="Personal">Personal</option>
                <option value="Emergency">Emergency</option>
                <option value="Maternity">Maternity</option>
                <option value="Paternity">Paternity</option>
                <option value="Bereavement">Bereavement</option>
            </select>

            <button (click)="loadData()" class="btn btn-secondary">Refresh</button>
        </div>
    </div>

    <!-- Requests Table -->
    <div class="requests-section">
        <div class="table-container">
            <table class="requests-table">
                <thead>
                    <tr>
                        <th *ngIf="isAdminOrManager()">Driver</th>
                        <th>Type</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Days</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th *ngIf="isAdminOrManager()">Approver</th>
                        <th class="actions-column">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let request of filteredRequests" class="request-row">
                        <td *ngIf="isAdminOrManager()" class="driver-name">
                            {{ request.driver?.name || 'Unknown' }}
                        </td>
                        <td>
                            <span class="type-badge" [ngClass]="getTypeClass(request.leaveTypeEnum)">
                                {{ getLeaveTypeString(request.leaveTypeEnum) }}
                            </span>
                        </td>
                        <td>{{ request.startDate | date:'shortDate' }}</td>
                        <td>{{ request.endDate | date:'shortDate' }}</td>
                        <td class="days-count">{{ request.totalDays }}</td>
                        <td class="reason-cell" [title]="request.reason">
                            {{ request.reason.length > 50 ? (request.reason | slice:0:50) + '...' : request.reason }}
                        </td>
                        <td>
                            <span class="status-badge" [ngClass]="getStatusClass(request.status)">
                                {{ getLeaveStatusString(request.status) }}
                            </span>
                        </td>
                        <td>{{ request.createdAt | date:'shortDate' }}</td>
                        <td *ngIf="isAdminOrManager()">
                            {{ request.approverUser?.name || '-' }}
                        </td>
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <button *ngIf="canApproveReject(request)"
                                        (click)="openApprovalModal(request)"
                                        class="btn btn-sm btn-success"
                                        title="Approve">
                                    ✓
                                </button>

                                <button *ngIf="canApproveReject(request)"
                                        (click)="openRejectionModal(request)"
                                        class="btn btn-sm btn-danger"
                                        title="Reject">
                                    ✗
                                </button>

                                <button *ngIf="canDelete(request)"
                                        (click)="deleteRequest(request)"
                                        class="btn btn-sm btn-outline-danger"
                                        title="Delete">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div *ngIf="filteredRequests.length === 0" class="no-data">
                <p>No leave requests found.</p>
            </div>
        </div>
    </div>

    <!-- ENHANCED APPROVAL MODAL WITH VALIDATION -->
    <div *ngIf="showApprovalModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Approve Leave Request</h3>
                <button type="button" class="close-btn" (click)="closeApprovalModal()">&times;</button>
            </div>

            <div class="modal-content" *ngIf="selectedRequest">
                <div class="request-details">
                    <p><strong>Driver:</strong> {{ selectedRequest.driver?.name }}</p>
                    <p><strong>Type:</strong> {{ getLeaveTypeString(selectedRequest.leaveTypeEnum) }}</p>
                    <p><strong>Dates:</strong> {{ selectedRequest.startDate | date:'shortDate' }} - {{ selectedRequest.endDate | date:'shortDate' }}</p>
                    <p><strong>Days:</strong> {{ selectedRequest.totalDays }}</p>
                    <p><strong>Reason:</strong> {{ selectedRequest.reason }}</p>
                </div>

                <form [formGroup]="approvalForm" (ngSubmit)="approveRequest()">
                    <div class="form-group">
                        <label for="approvalNotes">Approval Notes (Optional)</label>
                        <textarea formControlName="notes"
                                  id="approvalNotes"
                                  class="form-control"
                                  [class.invalid]="isFieldInvalid(approvalForm, 'notes')"
                                  [class.valid]="approvalForm.get('notes')?.valid && approvalForm.get('notes')?.touched"
                                  rows="3"
                                  placeholder="Add any notes about this approval...">
                        </textarea>
                        <div *ngIf="isFieldInvalid(approvalForm, 'notes')" class="error-text">
                            {{ getFieldErrorMessage(approvalForm, 'notes') }}
                        </div>
                        <div class="field-hint">Optional - Max 500 characters</div>
                    </div>

                    <div class="modal-actions">
                        <button type="submit"
                                [disabled]="loading"
                                class="btn btn-success">
                            {{ loading ? 'Approving...' : 'Approve Request' }}
                        </button>
                        <button type="button"
                                (click)="closeApprovalModal()"
                                class="btn btn-secondary">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ENHANCED REJECTION MODAL WITH VALIDATION -->
    <div *ngIf="showRejectionModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Reject Leave Request</h3>
                <button type="button" class="close-btn" (click)="closeRejectionModal()">&times;</button>
            </div>

            <div class="modal-content" *ngIf="selectedRequest">
                <div class="request-details">
                    <p><strong>Driver:</strong> {{ selectedRequest.driver?.name }}</p>
                    <p><strong>Type:</strong> {{ getLeaveTypeString(selectedRequest.leaveTypeEnum) }}</p>
                    <p><strong>Dates:</strong> {{ selectedRequest.startDate | date:'shortDate' }} - {{ selectedRequest.endDate | date:'shortDate' }}</p>
                    <p><strong>Days:</strong> {{ selectedRequest.totalDays }}</p>
                    <p><strong>Reason:</strong> {{ selectedRequest.reason }}</p>
                </div>

                <form [formGroup]="rejectionForm" (ngSubmit)="rejectRequest()">
                    <div class="form-group">
                        <label for="rejectionReason">Rejection Reason *</label>
                        <textarea formControlName="rejectionReason"
                                  id="rejectionReason"
                                  class="form-control"
                                  [class.invalid]="isFieldInvalid(rejectionForm, 'rejectionReason')"
                                  [class.valid]="rejectionForm.get('rejectionReason')?.valid && rejectionForm.get('rejectionReason')?.touched"
                                  rows="4"
                                  placeholder="Please provide a detailed reason for rejecting this request">
                        </textarea>
                        <div *ngIf="isFieldInvalid(rejectionForm, 'rejectionReason')" class="error-text">
                            {{ getFieldErrorMessage(rejectionForm, 'rejectionReason') }}
                        </div>
                        <div class="field-hint">10-500 characters required</div>
                    </div>

                    <div class="modal-actions">
                        <button type="submit"
                                [disabled]="loading"
                                class="btn btn-danger">
                            {{ loading ? 'Rejecting...' : 'Reject Request' }}
                        </button>
                        <button type="button"
                                (click)="closeRejectionModal()"
                                class="btn btn-secondary">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
