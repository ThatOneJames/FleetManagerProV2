<div class="profile-container">
    <div *ngIf="isLoading" class="loading-overlay">
        <mat-spinner diameter="50"></mat-spinner>
    </div>

    <div class="profile-header">
        <h1><mat-icon>person</mat-icon> My Profile</h1>
        <div class="header-actions">
            <button mat-raised-button color="accent" (click)="openChangePasswordModal()">
                <mat-icon>lock</mat-icon>
                Change Password
            </button>
            <button mat-raised-button
                    [color]="isEditing ? 'warn' : 'primary'"
                    (click)="toggleEdit()">
                <mat-icon>{{ isEditing ? 'close' : 'edit' }}</mat-icon>
                {{ isEditing ? 'Cancel' : 'Edit Profile' }}
            </button>
        </div>
    </div>

    <!-- Success Alert -->
    <mat-card *ngIf="successMessage" class="message-card success">
        <mat-icon>check_circle</mat-icon>
        <span>{{ successMessage }}</span>
    </mat-card>

    <!-- Error Alert -->
    <mat-card *ngIf="errorMessage" class="message-card error">
        <mat-icon>error</mat-icon>
        <span>{{ errorMessage }}</span>
    </mat-card>

    <!-- Profile Card -->
    <mat-card class="profile-card">
        <form [formGroup]="profileForm" (ngSubmit)="saveChanges()">

            <!-- Personal Information Section -->
            <div class="section-header">
                <mat-icon>person_outline</mat-icon>
                <h2>Personal Information</h2>
            </div>

            <div class="form-grid">
                <!-- Full Name -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Full Name *</mat-label>
                    <input matInput formControlName="name" [readonly]="!isEditing">
                    <mat-icon matPrefix>badge</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(profileForm, 'name')">
                        {{ getFieldErrorMessage(profileForm, 'name') }}
                    </mat-error>
                    <mat-hint>2-100 characters, letters only</mat-hint>
                </mat-form-field>

                <!-- Email -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Email *</mat-label>
                    <input matInput type="email" formControlName="email" [readonly]="!isEditing">
                    <mat-icon matPrefix>email</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(profileForm, 'email')">
                        {{ getFieldErrorMessage(profileForm, 'email') }}
                    </mat-error>
                </mat-form-field>

                <!-- Phone -->
                <mat-form-field appearance="outline">
                    <mat-label>Phone Number</mat-label>
                    <input matInput formControlName="phone" [readonly]="!isEditing">
                    <mat-icon matPrefix>phone</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(profileForm, 'phone')">
                        {{ getFieldErrorMessage(profileForm, 'phone') }}
                    </mat-error>
                    <mat-hint>Format: +63 912 345 6789 (Optional)</mat-hint>
                </mat-form-field>

                <!-- Date of Birth -->
                <mat-form-field appearance="outline">
                    <mat-label>Date of Birth</mat-label>
                    <input matInput type="date" formControlName="dateOfBirth" [readonly]="!isEditing">
                    <mat-icon matPrefix>cake</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(profileForm, 'dateOfBirth')">
                        {{ getFieldErrorMessage(profileForm, 'dateOfBirth') }}
                    </mat-error>
                    <mat-hint>Must be between 18 and 75 years old (Optional)</mat-hint>
                </mat-form-field>

                <!-- Address -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Address</mat-label>
                    <textarea matInput rows="2" formControlName="address" [readonly]="!isEditing"></textarea>
                    <mat-icon matPrefix>home</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(profileForm, 'address')">
                        {{ getFieldErrorMessage(profileForm, 'address') }}
                    </mat-error>
                    <mat-hint>Max 500 characters (Optional)</mat-hint>
                </mat-form-field>

                <!-- Emergency Contact -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Emergency Contact</mat-label>
                    <input matInput formControlName="emergencyContact" [readonly]="!isEditing">
                    <mat-icon matPrefix>emergency</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(profileForm, 'emergencyContact')">
                        {{ getFieldErrorMessage(profileForm, 'emergencyContact') }}
                    </mat-error>
                    <mat-hint>Max 200 characters (Optional)</mat-hint>
                </mat-form-field>
            </div>

            <!-- Driver License Information Section -->
            <div class="section-header">
                <mat-icon>directions_car</mat-icon>
                <h2>Driver License Information</h2>
            </div>

            <div class="form-grid">
                <!-- License Number -->
                <mat-form-field appearance="outline">
                    <mat-label>License Number *</mat-label>
                    <input matInput formControlName="licenseNumber" [readonly]="!isEditing">
                    <mat-icon matPrefix>credit_card</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(profileForm, 'licenseNumber')">
                        {{ getFieldErrorMessage(profileForm, 'licenseNumber') }}
                    </mat-error>
                    <mat-hint>5-50 characters</mat-hint>
                </mat-form-field>

                <!-- License Classes (Display Mode) -->
                <mat-form-field appearance="outline" class="full-width" *ngIf="!isEditing">
                    <mat-label>License Classes</mat-label>
                    <input matInput [value]="licenseClassesFormArray.value.join(', ')" [readonly]="true">
                    <mat-icon matPrefix>category</mat-icon>
                </mat-form-field>

                <!-- License Classes (Edit Mode) -->
                <div class="form-group license-checkboxes full-width" *ngIf="isEditing">
                    <label class="mat-label">License Classes * (Select at least one)</label>
                    <div class="checkbox-group">
                        <mat-checkbox *ngFor="let licenseClass of availableLicenseClasses"
                                      [checked]="isLicenseClassSelected(licenseClass.code)"
                                      (change)="onLicenseClassChange(licenseClass.code, $event)">
                            <strong>{{ licenseClass.code }}</strong> - {{ licenseClass.name }}
                        </mat-checkbox>
                    </div>
                    <mat-error *ngIf="licenseClassesFormArray.invalid && licenseClassesFormArray.touched">
                        Please select at least one license class
                    </mat-error>
                </div>

                <!-- License Expiry -->
                <mat-form-field appearance="outline">
                    <mat-label>License Expiry *</mat-label>
                    <input matInput type="date" formControlName="licenseExpiry" [readonly]="!isEditing">
                    <mat-icon matPrefix>event</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(profileForm, 'licenseExpiry')">
                        {{ getFieldErrorMessage(profileForm, 'licenseExpiry') }}
                    </mat-error>
                    <mat-hint>Must be today or in the future</mat-hint>
                </mat-form-field>

                <!-- Experience Years -->
                <mat-form-field appearance="outline">
                    <mat-label>Experience (Years)</mat-label>
                    <input matInput type="number" formControlName="experienceYears" [readonly]="!isEditing">
                    <mat-icon matPrefix>timeline</mat-icon>
                    <mat-error *ngIf="isFieldInvalid(profileForm, 'experienceYears')">
                        {{ getFieldErrorMessage(profileForm, 'experienceYears') }}
                    </mat-error>
                    <mat-hint>0-50 years (Optional)</mat-hint>
                </mat-form-field>
            </div>

            <!-- Form Actions -->
            <div class="form-actions" *ngIf="isEditing">
                <button mat-raised-button type="button" (click)="toggleEdit()">
                    Cancel
                </button>
                <button mat-raised-button color="primary" type="submit" [disabled]="isLoading">
                    <mat-icon>save</mat-icon>
                    Save Changes
                </button>
            </div>
        </form>
    </mat-card>

    <!-- ENHANCED CHANGE PASSWORD MODAL WITH VALIDATION -->
    <div class="modal-overlay" *ngIf="showChangePasswordModal" (click)="closeChangePasswordModal()">
        <mat-card class="change-password-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2><mat-icon>lock</mat-icon> Change Password</h2>
                <button mat-icon-button (click)="closeChangePasswordModal()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <form [formGroup]="changePasswordForm" (ngSubmit)="changePassword()">
                <!-- Current Password -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Current Password *</mat-label>
                    <input matInput [type]="showCurrentPassword ? 'text' : 'password'" formControlName="currentPassword">
                    <mat-icon matPrefix>lock_outline</mat-icon>
                    <button mat-icon-button matSuffix type="button" (click)="toggleCurrentPassword()" tabindex="-1">
                        <mat-icon>{{ showCurrentPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>
                    <mat-error *ngIf="isFieldInvalid(changePasswordForm, 'currentPassword')">
                        {{ getFieldErrorMessage(changePasswordForm, 'currentPassword') }}
                    </mat-error>
                </mat-form-field>

                <!-- New Password -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>New Password *</mat-label>
                    <input matInput [type]="showNewPassword ? 'text' : 'password'" formControlName="newPassword">
                    <mat-icon matPrefix>lock</mat-icon>
                    <button mat-icon-button matSuffix type="button" (click)="toggleNewPassword()" tabindex="-1">
                        <mat-icon>{{ showNewPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>
                    <mat-error *ngIf="isFieldInvalid(changePasswordForm, 'newPassword')">
                        {{ getFieldErrorMessage(changePasswordForm, 'newPassword') }}
                    </mat-error>
                    <mat-hint>Min 6 chars, must contain letters and numbers</mat-hint>
                </mat-form-field>

                <!-- Confirm New Password -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Confirm New Password *</mat-label>
                    <input matInput [type]="showConfirmPassword ? 'text' : 'password'" formControlName="confirmPassword">
                    <mat-icon matPrefix>lock</mat-icon>
                    <button mat-icon-button matSuffix type="button" (click)="toggleConfirmPassword()" tabindex="-1">
                        <mat-icon>{{ showConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>
                    <mat-error *ngIf="isFieldInvalid(changePasswordForm, 'confirmPassword')">
                        {{ getFieldErrorMessage(changePasswordForm, 'confirmPassword') }}
                    </mat-error>
                    <mat-error *ngIf="changePasswordForm.hasError('passwordMismatch') && changePasswordForm.get('confirmPassword')?.touched">
                        Passwords do not match
                    </mat-error>
                </mat-form-field>

                <!-- Modal Actions -->
                <div class="modal-actions">
                    <button mat-button type="button" (click)="closeChangePasswordModal()">
                        Cancel
                    </button>
                    <button mat-raised-button color="primary" type="submit" [disabled]="isLoading">
                        <mat-icon>check</mat-icon>
                        Change Password
                    </button>
                </div>
            </form>
        </mat-card>
    </div>
</div>
